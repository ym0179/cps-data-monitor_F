{% extends "base.html" %}

{% block title %}Earnings Trading - 고객상품전략팀{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 600;
        color: #1f2937;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
    }

    .vix-insight {
        font-size: 0.8125rem;
        line-height: 1.6;
        color: #4b5563;
    }

    .vix-insight strong {
        color: #1f2937;
        font-weight: 600;
    }

    .vix-insight .subtitle {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-left: 0.5rem;
    }

    .chart-container {
        position: relative;
        height: 350px;
    }

    .earnings-table {
        font-size: 0.875rem;
    }

    .earnings-table th {
        background-color: #f9fafb;
        font-weight: 600;
        color: #374151;
        padding: 0.75rem;
        cursor: pointer;
        user-select: none;
        position: relative;
    }

    .earnings-table th.sortable:hover {
        background-color: #f3f4f6;
    }

    .earnings-table th.sortable::after {
        content: '⇅';
        margin-left: 0.5rem;
        color: #9ca3af;
        font-size: 0.75rem;
    }

    .earnings-table th.sort-asc::after {
        content: '↑';
        color: #3b82f6;
    }

    .earnings-table th.sort-desc::after {
        content: '↓';
        color: #3b82f6;
    }

    .earnings-table td {
        padding: 0.75rem;
        vertical-align: middle;
        color: #374151;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .earnings-table td small {
        color: #6b7280;
    }

    .earnings-table th small {
        font-size: 0.7rem;
        color: #9ca3af;
        font-weight: 400;
        display: block;
        margin-top: 0.125rem;
    }

    .filter-row {
        background-color: #f9fafb;
    }

    .filter-row th {
        padding: 0.5rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .filter-input {
        width: 100%;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        outline: none;
    }

    .filter-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 1px #3b82f6;
    }

    .filter-select {
        width: 100%;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        outline: none;
        background-color: white;
    }

    .filter-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 1px #3b82f6;
    }

    .load-more-container {
        text-align: center;
        padding: 1.5rem;
        border-top: 1px solid #e5e7eb;
    }

    .load-more-btn {
        padding: 0.5rem 1.5rem;
        background-color: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .load-more-btn:hover {
        background-color: #e5e7eb;
    }

    .badge-score {
        padding: 0.375rem 0.75rem;
        font-weight: 600;
    }

    .loading-spinner {
        border: 3px solid #f3f4f6;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-semibold text-gray-900">Earnings Trading</h1>
        <p class="text-gray-600 mt-1">Goldman Sachs methodology: Idiosyncratic volatility analysis on earnings dates</p>
    </div>

    <!-- VIX Chart Section -->
    <div class="card stat-card mb-6">
        <div class="card-body p-6">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h5 class="font-semibold text-gray-900 mb-1">VIX Index (Market Volatility)</h5>
                    <div class="d-flex align-items-baseline gap-2">
                        <span class="stat-value" id="vixValue">-</span>
                        <span id="vixChange" class="text-sm"></span>
                    </div>
                </div>
                <div>
                    <span id="vixBadge" class="badge bg-secondary">Loading...</span>
                </div>
            </div>

            <!-- VIX Chart -->
            <div class="chart-container mb-4">
                <canvas id="vixChart"></canvas>
            </div>

            <!-- GS Strategy Insight -->
            <div class="vix-insight p-4" style="background-color: #f9fafb; border-radius: 8px;">
                <div class="mb-2" style="font-weight: 600; color: #1f2937;">*GS Strategy Insight: VIX 수준에 따른 실적 이벤트 성과</div>
                <div class="mb-2">
                    <span style="color: #6b7280;">-</span> VIX 수준은 실적 이벤트 트레이드 성과에 유의미한 영향을 미침
                </div>
                <div class="ps-3">
                    <div class="mb-1">
                        <strong>최적 구간 (VIX 35~45):</strong>
                        <span class="subtitle">거시 불확실성이 높은 환경에서 실적 발표가 불확실성 해소(Relief Rally)로 작용</span>
                    </div>
                    <div class="mb-1">
                        <strong>안정~불안 (VIX 35 이하):</strong>
                        <span class="subtitle">주가 변동폭은 작고 방향성은 불확실하나, 평균적으로 시장을 소폭 상회</span>
                    </div>
                    <div>
                        <strong>위험 구간 (VIX 45 초과):</strong>
                        <span class="subtitle">극단적 공포 국면. 실적 발표로 신뢰 회복이 어려우며, 시장 대비 언더퍼폼</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Earnings Events Section -->
    <div class="card stat-card">
        <div class="card-header bg-white border-bottom py-3 px-4">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="font-semibold text-gray-900 mb-0">Earnings Events</h5>
                <button class="btn btn-sm btn-outline-primary" id="refreshBtn">
                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-5">
                <div class="loading-spinner mx-auto mb-3"></div>
                <p class="text-gray-600">Loading earnings data...</p>
            </div>

            <!-- Table -->
            <div id="tableContainer" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-hover earnings-table mb-0">
                        <thead>
                            <tr>
                                <th style="width: 7%;" class="sortable" data-sort="symbol">Symbol</th>
                                <th style="width: 18%;" class="sortable" data-sort="company">Company</th>
                                <th style="width: 8%;" class="sortable" data-sort="date">Date</th>
                                <th style="width: 7%;" class="sortable" data-sort="calltime">Call Time</th>
                                <th style="width: 7%;" class="text-end sortable" data-sort="eps">EPS Est.</th>
                                <th style="width: 8%;" class="sortable" data-sort="marketcap">Market Cap</th>
                                <th style="width: 9%;" class="sortable" data-sort="rating">Analyst Rating</th>
                                <th style="width: 6%;" class="text-center sortable" data-sort="analystcount"># Analysts</th>
                                <th style="width: 8%;" class="text-end sortable" data-sort="avgmove">Avg Move (%)<small>3yr avg</small></th>
                                <th style="width: 7%;" class="text-end sortable" data-sort="volatility">Vol (%)<small>3yr std</small></th>
                                <th style="width: 15%;" class="sortable" data-sort="alert">Trade Alert</th>
                            </tr>
                            <!-- Filter Row -->
                            <tr class="filter-row">
                                <th><input type="text" class="filter-input" id="filterSymbol" placeholder="Filter..."></th>
                                <th><input type="text" class="filter-input" id="filterCompany" placeholder="Filter..."></th>
                                <th><input type="date" class="filter-input" id="filterDate"></th>
                                <th>
                                    <select class="filter-select" id="filterCallTime">
                                        <option value="">All</option>
                                        <option value="장전">장전</option>
                                        <option value="장후">장후</option>
                                    </select>
                                </th>
                                <th></th>
                                <th></th>
                                <th>
                                    <select class="filter-select" id="filterRating">
                                        <option value="">All</option>
                                        <option value="Strong Buy">Strong Buy</option>
                                        <option value="Buy">Buy</option>
                                        <option value="Hold">Hold</option>
                                        <option value="Sell">Sell</option>
                                    </select>
                                </th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th>
                                    <select class="filter-select" id="filterAlert">
                                        <option value="">All</option>
                                        <option value="alert">With Alert</option>
                                    </select>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="earningsTableBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
                <!-- Load More Button -->
                <div id="loadMoreContainer" class="load-more-container" style="display: none;">
                    <button class="load-more-btn" onclick="loadMoreRows()">
                        <i class="bi bi-arrow-down-circle me-2"></i>Load More (<span id="remainingCount">0</span> remaining)
                    </button>
                </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="text-center py-5" style="display: none;">
                <i class="bi bi-inbox text-gray-400" style="font-size: 3rem;"></i>
                <p class="text-gray-600 mt-3">No earnings events found</p>
                <p class="text-gray-500 small">Try adjusting your date range or refresh the data</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let vixChart = null;

// Load VIX Data and Create Chart
async function loadVIXData() {
    try {
        const response = await fetch('/api/vix/history?years=10');
        const data = await response.json();

        if (data.dates && data.dates.length > 0) {
            // Update current VIX value
            document.getElementById('vixValue').textContent = data.current || '-';

            // Update badge based on current VIX
            updateVIXBadge(data.current);

            // Create chart
            createVIXChart(data.dates, data.values);
        }
    } catch (error) {
        console.error('VIX load error:', error);
        document.getElementById('vixValue').textContent = 'N/A';
    }
}

function updateVIXBadge(vix) {
    const badge = document.getElementById('vixBadge');

    if (vix < 20) {
        badge.textContent = 'Stable';
        badge.className = 'badge bg-success';
    } else if (vix < 35) {
        badge.textContent = 'Elevated';
        badge.className = 'badge bg-warning';
    } else if (vix <= 45) {
        badge.textContent = 'Optimal Zone';
        badge.className = 'badge bg-primary';
    } else {
        badge.textContent = 'Danger';
        badge.className = 'badge bg-danger';
    }
}

function createVIXChart(dates, values) {
    const ctx = document.getElementById('vixChart').getContext('2d');

    // Destroy existing chart if any
    if (vixChart) {
        vixChart.destroy();
    }

    vixChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'VIX Index',
                data: values,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: {
                        size: 12
                    },
                    bodyFont: {
                        size: 12
                    },
                    padding: 10,
                    displayColors: false
                }
            },
            scales: {
                x: {
                    display: true,
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxTicksLimit: 10,
                        font: {
                            size: 11
                        }
                    }
                },
                y: {
                    display: true,
                    grid: {
                        color: '#f3f4f6'
                    },
                    ticks: {
                        font: {
                            size: 11
                        }
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
}

// Global state
let allEarningsData = [];
let filteredData = [];
let currentPage = 0;
const ITEMS_PER_PAGE = 20;
let currentSort = {
    column: null,
    direction: null  // 'asc' or 'desc'
};

// Load Earnings Events from API
async function loadEarningsEvents() {
    // Show loading
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('tableContainer').style.display = 'none';
    document.getElementById('emptyState').style.display = 'none';

    try {
        // Call API
        const response = await fetch('/api/earnings/calendar?days=7');
        const data = await response.json();

        console.log('API Response:', data); // Debug log

        if (data.length > 0) {
            allEarningsData = data;
            filteredData = data;
            currentPage = 0;
            renderEarningsTable();
            document.getElementById('tableContainer').style.display = 'block';
        } else {
            document.getElementById('emptyState').style.display = 'block';
        }
    } catch (error) {
        console.error('Earnings load error:', error);
        document.getElementById('emptyState').style.display = 'block';
    } finally {
        document.getElementById('loadingState').style.display = 'none';
    }
}

function applyFilters() {
    const symbolFilter = document.getElementById('filterSymbol').value.toLowerCase();
    const companyFilter = document.getElementById('filterCompany').value.toLowerCase();
    const dateFilter = document.getElementById('filterDate').value;
    const callTimeFilter = document.getElementById('filterCallTime').value;
    const ratingFilter = document.getElementById('filterRating').value;
    const alertFilter = document.getElementById('filterAlert').value;

    filteredData = allEarningsData.filter(item => {
        // Symbol filter
        if (symbolFilter && !item.Symbol.toLowerCase().includes(symbolFilter)) {
            return false;
        }

        // Company filter
        if (companyFilter && !item.Company.toLowerCase().includes(companyFilter)) {
            return false;
        }

        // Date filter
        if (dateFilter && item.Date !== dateFilter) {
            return false;
        }

        // Call Time filter
        if (callTimeFilter && item.CallTime !== callTimeFilter) {
            return false;
        }

        // Rating filter
        if (ratingFilter) {
            const ratingText = getRatingText(item.AnalystRating);
            if (ratingText !== ratingFilter) {
                return false;
            }
        }

        // Alert filter
        if (alertFilter === 'alert' && (!item.TradeAlert || item.TradeAlert === '-')) {
            return false;
        }

        return true;
    });

    // Apply current sort if exists
    if (currentSort.column) {
        applySorting();
    }

    currentPage = 0;
    renderEarningsTable();
}

function sortData(column) {
    // Toggle sort direction
    if (currentSort.column === column) {
        if (currentSort.direction === 'asc') {
            currentSort.direction = 'desc';
        } else if (currentSort.direction === 'desc') {
            currentSort.column = null;
            currentSort.direction = null;
        } else {
            currentSort.direction = 'asc';
        }
    } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
    }

    // Update UI
    document.querySelectorAll('.sortable').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
    });

    if (currentSort.column) {
        const th = document.querySelector(`[data-sort="${column}"]`);
        if (th) {
            th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
        }
        applySorting();
    } else {
        // Reset to original order
        filteredData = [...filteredData];
    }

    currentPage = 0;
    renderEarningsTable();
}

function applySorting() {
    if (!currentSort.column) return;

    filteredData.sort((a, b) => {
        let aVal, bVal;

        switch(currentSort.column) {
            case 'symbol':
                aVal = a.Symbol || '';
                bVal = b.Symbol || '';
                break;
            case 'company':
                aVal = a.Company || '';
                bVal = b.Company || '';
                break;
            case 'date':
                aVal = a.Date || '';
                bVal = b.Date || '';
                break;
            case 'calltime':
                aVal = a.CallTime || '';
                bVal = b.CallTime || '';
                break;
            case 'eps':
                aVal = parseFloat(a.EPSEstimate) || 0;
                bVal = parseFloat(b.EPSEstimate) || 0;
                break;
            case 'marketcap':
                aVal = parseMarketCap(a.MarketCap);
                bVal = parseMarketCap(b.MarketCap);
                break;
            case 'rating':
                aVal = getRatingValue(a.AnalystRating);
                bVal = getRatingValue(b.AnalystRating);
                break;
            case 'analystcount':
                aVal = a.AnalystCount || 0;
                bVal = b.AnalystCount || 0;
                break;
            case 'avgmove':
                aVal = a.AvgMove !== null && a.AvgMove !== undefined ? a.AvgMove : -Infinity;
                bVal = b.AvgMove !== null && b.AvgMove !== undefined ? b.AvgMove : -Infinity;
                break;
            case 'volatility':
                aVal = a.Volatility !== null && a.Volatility !== undefined ? a.Volatility : -Infinity;
                bVal = b.Volatility !== null && b.Volatility !== undefined ? b.Volatility : -Infinity;
                break;
            case 'alert':
                aVal = a.TradeAlert && a.TradeAlert !== '-' ? 1 : 0;
                bVal = b.TradeAlert && b.TradeAlert !== '-' ? 1 : 0;
                break;
            default:
                return 0;
        }

        // String comparison
        if (typeof aVal === 'string') {
            return currentSort.direction === 'asc'
                ? aVal.localeCompare(bVal)
                : bVal.localeCompare(aVal);
        }

        // Number comparison
        return currentSort.direction === 'asc'
            ? aVal - bVal
            : bVal - aVal;
    });
}

function parseMarketCap(capStr) {
    if (!capStr || capStr === '-') return 0;

    const num = parseFloat(capStr);
    if (isNaN(num)) return 0;

    if (capStr.includes('T')) return num * 1000000000000;
    if (capStr.includes('B')) return num * 1000000000;
    if (capStr.includes('M')) return num * 1000000;
    return num;
}

function getRatingValue(rating) {
    if (!rating) return 999;
    const r = rating.toLowerCase();
    if (r.includes('strong buy')) return 1;
    if (r.includes('buy')) return 2;
    if (r.includes('hold')) return 3;
    if (r.includes('sell')) return 4;
    return 999;
}

function getRatingText(rating) {
    if (!rating) return 'N/A';
    const r = rating.toLowerCase();
    if (r.includes('strong buy')) return 'Strong Buy';
    if (r.includes('buy')) return 'Buy';
    if (r.includes('hold')) return 'Hold';
    if (r.includes('sell')) return 'Sell';
    return rating;
}

function renderEarningsTable() {
    const tbody = document.getElementById('earningsTableBody');
    tbody.innerHTML = '';

    const startIdx = 0;
    const endIdx = (currentPage + 1) * ITEMS_PER_PAGE;
    const dataToShow = filteredData.slice(startIdx, endIdx);

    dataToShow.forEach(item => {
        const row = document.createElement('tr');

        // Analyst Rating badge
        let ratingBadgeClass = 'bg-secondary';
        let ratingText = getRatingText(item.AnalystRating);

        if (item.AnalystRating) {
            const rating = item.AnalystRating.toLowerCase();
            if (rating.includes('strong buy')) {
                ratingBadgeClass = 'bg-success';
            } else if (rating.includes('buy')) {
                ratingBadgeClass = 'bg-primary';
            } else if (rating.includes('hold')) {
                ratingBadgeClass = 'bg-warning';
            } else if (rating.includes('sell')) {
                ratingBadgeClass = 'bg-danger';
            }
        }

        // Trade Alert
        let tradeAlertHTML = '<span class="text-muted">-</span>';
        if (item.TradeAlert && item.TradeAlert !== '-') {
            tradeAlertHTML = `<span class="badge bg-info text-dark">${item.TradeAlert}</span>`;
        }

        // Format values
        const avgMove = item.AvgMove !== null && item.AvgMove !== undefined ? item.AvgMove.toFixed(2) + '%' : '-';
        const volatility = item.Volatility !== null && item.Volatility !== undefined ? item.Volatility.toFixed(2) + '%' : '-';
        const epsEstimate = item.EPSEstimate || '-';
        const marketCap = item.MarketCap || '-';
        const analystCount = item.AnalystCount || '-';

        row.innerHTML = `
            <td><span class="fw-bold" style="font-family: 'Monaco', 'Courier New', monospace;">${item.Symbol}</span></td>
            <td>${item.Company}</td>
            <td>${item.Date}</td>
            <td><span class="badge ${item.CallTime === '장전' ? 'bg-warning text-dark' : 'bg-info text-dark'}">${item.CallTime}</span></td>
            <td class="text-end">${epsEstimate}</td>
            <td>${marketCap}</td>
            <td><span class="badge ${ratingBadgeClass}">${ratingText}</span></td>
            <td class="text-center">${analystCount}</td>
            <td class="text-end">${avgMove}</td>
            <td class="text-end">${volatility}</td>
            <td>${tradeAlertHTML}</td>
        `;

        tbody.appendChild(row);
    });

    // Update load more button
    const remaining = filteredData.length - endIdx;
    if (remaining > 0) {
        document.getElementById('loadMoreContainer').style.display = 'block';
        document.getElementById('remainingCount').textContent = remaining;
    } else {
        document.getElementById('loadMoreContainer').style.display = 'none';
    }
}

function loadMoreRows() {
    currentPage++;
    renderEarningsTable();
}

// Refresh Button
document.getElementById('refreshBtn').addEventListener('click', () => {
    loadEarningsEvents();
});

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadVIXData();
    loadEarningsEvents();

    // Add filter event listeners
    document.getElementById('filterSymbol').addEventListener('input', applyFilters);
    document.getElementById('filterCompany').addEventListener('input', applyFilters);
    document.getElementById('filterDate').addEventListener('change', applyFilters);
    document.getElementById('filterCallTime').addEventListener('change', applyFilters);
    document.getElementById('filterRating').addEventListener('change', applyFilters);
    document.getElementById('filterAlert').addEventListener('change', applyFilters);

    // Add sort event listeners
    document.querySelectorAll('.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const sortColumn = th.getAttribute('data-sort');
            sortData(sortColumn);
        });
    });
});
</script>
{% endblock %}
