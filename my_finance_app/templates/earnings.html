{% extends "base.html" %}

{% block title %}Earnings Trading - 고객상품전략팀{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 600;
        color: #1f2937;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
    }

    .vix-insight {
        font-size: 0.8125rem;
        line-height: 1.6;
        color: #4b5563;
    }

    .vix-insight strong {
        color: #1f2937;
        font-weight: 600;
    }

    .vix-insight .subtitle {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-left: 0.5rem;
    }

    .chart-container {
        position: relative;
        height: 350px;
    }

    .earnings-table {
        font-size: 0.875rem;
    }

    .earnings-table th {
        background-color: #f9fafb;
        font-weight: 600;
        color: #374151;
        padding: 0.75rem;
    }

    .earnings-table td {
        padding: 0.75rem;
        vertical-align: middle;
        color: #374151;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .earnings-table td small {
        color: #6b7280;
    }

    .badge-score {
        padding: 0.375rem 0.75rem;
        font-weight: 600;
    }

    .loading-spinner {
        border: 3px solid #f3f4f6;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-semibold text-gray-900">Earnings Trading</h1>
        <p class="text-gray-600 mt-1">Goldman Sachs methodology: Idiosyncratic volatility analysis on earnings dates</p>
    </div>

    <!-- VIX Chart Section -->
    <div class="card stat-card mb-6">
        <div class="card-body p-6">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h5 class="font-semibold text-gray-900 mb-1">VIX Index (Market Volatility)</h5>
                    <div class="d-flex align-items-baseline gap-2">
                        <span class="stat-value" id="vixValue">-</span>
                        <span id="vixChange" class="text-sm"></span>
                    </div>
                </div>
                <div>
                    <span id="vixBadge" class="badge bg-secondary">Loading...</span>
                </div>
            </div>

            <!-- VIX Chart -->
            <div class="chart-container mb-4">
                <canvas id="vixChart"></canvas>
            </div>

            <!-- GS Strategy Insight -->
            <div class="vix-insight p-4" style="background-color: #f9fafb; border-radius: 8px;">
                <div class="mb-2" style="font-weight: 600; color: #1f2937;">*GS Strategy Insight: VIX 수준에 따른 실적 이벤트 성과</div>
                <div class="mb-2">
                    <span style="color: #6b7280;">-</span> VIX 수준은 실적 이벤트 트레이드 성과에 유의미한 영향을 미침
                </div>
                <div class="ps-3">
                    <div class="mb-1">
                        <strong>최적 구간 (VIX 35~45):</strong>
                        <span class="subtitle">거시 불확실성이 높은 환경에서 실적 발표가 불확실성 해소(Relief Rally)로 작용</span>
                    </div>
                    <div class="mb-1">
                        <strong>안정~불안 (VIX 35 이하):</strong>
                        <span class="subtitle">주가 변동폭은 작고 방향성은 불확실하나, 평균적으로 시장을 소폭 상회</span>
                    </div>
                    <div>
                        <strong>위험 구간 (VIX 45 초과):</strong>
                        <span class="subtitle">극단적 공포 국면. 실적 발표로 신뢰 회복이 어려우며, 시장 대비 언더퍼폼</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Earnings Events Section -->
    <div class="card stat-card">
        <div class="card-header bg-white border-bottom py-3 px-4">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="font-semibold text-gray-900 mb-0">Earnings Events</h5>
                <button class="btn btn-sm btn-outline-primary" id="refreshBtn">
                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-5">
                <div class="loading-spinner mx-auto mb-3"></div>
                <p class="text-gray-600">Loading earnings data...</p>
            </div>

            <!-- Table -->
            <div id="tableContainer" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-hover earnings-table mb-0">
                        <thead>
                            <tr>
                                <th style="width: 7%;">Symbol</th>
                                <th style="width: 18%;">Company</th>
                                <th style="width: 8%;">Date</th>
                                <th style="width: 7%;">Call Time</th>
                                <th style="width: 7%;" class="text-end">EPS Est.</th>
                                <th style="width: 8%;">Market Cap</th>
                                <th style="width: 9%;">Analyst Rating</th>
                                <th style="width: 6%;" class="text-center"># Analysts</th>
                                <th style="width: 8%;" class="text-end">Avg Move (%)<br><small class="text-muted fw-normal">3yr avg</small></th>
                                <th style="width: 7%;" class="text-end">Vol (%)<br><small class="text-muted fw-normal">3yr std</small></th>
                                <th style="width: 15%;">Trade Alert</th>
                            </tr>
                        </thead>
                        <tbody id="earningsTableBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="text-center py-5" style="display: none;">
                <i class="bi bi-inbox text-gray-400" style="font-size: 3rem;"></i>
                <p class="text-gray-600 mt-3">No earnings events found</p>
                <p class="text-gray-500 small">Try adjusting your date range or refresh the data</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let vixChart = null;

// Load VIX Data and Create Chart
async function loadVIXData() {
    try {
        const response = await fetch('/api/vix/history?years=10');
        const data = await response.json();

        if (data.dates && data.dates.length > 0) {
            // Update current VIX value
            document.getElementById('vixValue').textContent = data.current || '-';

            // Update badge based on current VIX
            updateVIXBadge(data.current);

            // Create chart
            createVIXChart(data.dates, data.values);
        }
    } catch (error) {
        console.error('VIX load error:', error);
        document.getElementById('vixValue').textContent = 'N/A';
    }
}

function updateVIXBadge(vix) {
    const badge = document.getElementById('vixBadge');

    if (vix < 20) {
        badge.textContent = 'Stable';
        badge.className = 'badge bg-success';
    } else if (vix < 35) {
        badge.textContent = 'Elevated';
        badge.className = 'badge bg-warning';
    } else if (vix <= 45) {
        badge.textContent = 'Optimal Zone';
        badge.className = 'badge bg-primary';
    } else {
        badge.textContent = 'Danger';
        badge.className = 'badge bg-danger';
    }
}

function createVIXChart(dates, values) {
    const ctx = document.getElementById('vixChart').getContext('2d');

    // Destroy existing chart if any
    if (vixChart) {
        vixChart.destroy();
    }

    vixChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'VIX Index',
                data: values,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: {
                        size: 12
                    },
                    bodyFont: {
                        size: 12
                    },
                    padding: 10,
                    displayColors: false
                }
            },
            scales: {
                x: {
                    display: true,
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxTicksLimit: 10,
                        font: {
                            size: 11
                        }
                    }
                },
                y: {
                    display: true,
                    grid: {
                        color: '#f3f4f6'
                    },
                    ticks: {
                        font: {
                            size: 11
                        }
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
}

// Load Earnings Events from API
async function loadEarningsEvents() {
    // Show loading
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('tableContainer').style.display = 'none';
    document.getElementById('emptyState').style.display = 'none';

    try {
        // Call API
        const response = await fetch('/api/earnings/calendar?days=7');
        const data = await response.json();

        if (data.length > 0) {
            renderEarningsTable(data);
            document.getElementById('tableContainer').style.display = 'block';
        } else {
            document.getElementById('emptyState').style.display = 'block';
        }
    } catch (error) {
        console.error('Earnings load error:', error);
        document.getElementById('emptyState').style.display = 'block';
    } finally {
        document.getElementById('loadingState').style.display = 'none';
    }
}

function renderEarningsTable(data) {
    const tbody = document.getElementById('earningsTableBody');
    tbody.innerHTML = '';

    data.forEach(item => {
        const row = document.createElement('tr');

        // Analyst Rating badge
        let ratingBadgeClass = 'bg-secondary';
        let ratingText = item.AnalystRating || 'N/A';

        if (item.AnalystRating) {
            const rating = item.AnalystRating.toLowerCase();
            if (rating.includes('strong buy')) {
                ratingBadgeClass = 'bg-success';
                ratingText = 'Strong Buy';
            } else if (rating.includes('buy')) {
                ratingBadgeClass = 'bg-primary';
                ratingText = 'Buy';
            } else if (rating.includes('hold')) {
                ratingBadgeClass = 'bg-warning';
                ratingText = 'Hold';
            } else if (rating.includes('sell')) {
                ratingBadgeClass = 'bg-danger';
                ratingText = 'Sell';
            }
        }

        // Trade Alert
        let tradeAlertHTML = '<span class="text-muted">-</span>';
        if (item.TradeAlert && item.TradeAlert !== '-') {
            tradeAlertHTML = `<span class="badge bg-info text-dark">${item.TradeAlert}</span>`;
        }

        // Format values
        const avgMove = item.AvgMove !== null && item.AvgMove !== undefined ? item.AvgMove.toFixed(2) + '%' : '-';
        const volatility = item.Volatility !== null && item.Volatility !== undefined ? item.Volatility.toFixed(2) + '%' : '-';
        const epsEstimate = item.EPSEstimate || '-';
        const marketCap = item.MarketCap || '-';
        const analystCount = item.AnalystCount || '-';

        row.innerHTML = `
            <td><span class="fw-bold" style="font-family: 'Monaco', 'Courier New', monospace;">${item.Symbol}</span></td>
            <td>${item.Company}</td>
            <td>${item.Date}</td>
            <td><span class="badge ${item.CallTime === '장전' ? 'bg-warning text-dark' : 'bg-info text-dark'}">${item.CallTime}</span></td>
            <td class="text-end">${epsEstimate}</td>
            <td>${marketCap}</td>
            <td><span class="badge ${ratingBadgeClass}">${ratingText}</span></td>
            <td class="text-center">${analystCount}</td>
            <td class="text-end">${avgMove}</td>
            <td class="text-end">${volatility}</td>
            <td>${tradeAlertHTML}</td>
        `;

        tbody.appendChild(row);
    });
}

// Refresh Button
document.getElementById('refreshBtn').addEventListener('click', () => {
    loadEarningsEvents();
});

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadVIXData();
    loadEarningsEvents();
});
</script>
{% endblock %}
