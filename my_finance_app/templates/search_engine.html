{% extends "base.html" %}

{% block title %}Search Engine M/S - Market Data{% endblock %}

{% block extra_css %}
<style>
    .data-table {
        font-size: 11px;
        overflow-x: auto;
    }
    .data-table table {
        min-width: 100%;
        border-collapse: collapse;
    }
    .data-table th, .data-table td {
        padding: 4px 6px;
        text-align: center;
        border: 1px solid #ddd;
        white-space: nowrap;
    }
    .data-table th {
        background: #f5f5f5;
        font-weight: 600;
        position: sticky;
        left: 0;
        z-index: 1;
    }
    .data-table td:first-child {
        position: sticky;
        left: 0;
        background: #fff;
        font-weight: 500;
        z-index: 1;
    }
    /* 색상 포맷팅 */
    .bg-google { background-color: #c6efce !important; color: #006100; }
    .bg-yahoo { background-color: #fff2cc !important; }
    .bg-other { background-color: #f2f2f2 !important; }
    .bg-bing { background-color: #ffc7ce !important; color: #9c0006; }

    .section-title {
        background: linear-gradient(90deg, #198754 0%, #20c997 100%);
        color: white;
        padding: 8px 15px;
        font-weight: 600;
        margin-bottom: 0;
    }
    .chart-container {
        height: 400px;
    }
    .table-scroll {
        max-height: 200px;
        overflow-y: auto;
    }
    .filter-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-3">
    <!-- 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="mb-1"><i class="bi bi-search text-success me-2"></i>Search Engine M/S</h4>
            <p class="text-muted mb-0">
                <small>Data Source: <a href="https://gs.statcounter.com/search-engine-market-share" target="_blank">StatCounter Global Stats</a> (Jan 2009 ~ Present)</small>
            </p>
        </div>
        <div>
            <a href="/api/search-engine/download" class="btn btn-success btn-sm">
                <i class="bi bi-file-earmark-excel me-1"></i>Excel 다운로드
            </a>
            <a href="/market" class="btn btn-outline-secondary btn-sm ms-2">
                <i class="bi bi-arrow-left me-1"></i>Market Data
            </a>
        </div>
    </div>

    <!-- 날짜 필터 섹션 -->
    <div class="filter-section">
        <div class="row align-items-center">
            <div class="col-auto">
                <label class="form-label mb-0 fw-bold"><i class="bi bi-calendar-range me-1"></i>기간 선택:</label>
            </div>
            <div class="col-auto">
                <select id="filterFrom" class="form-select form-select-sm" style="width: 140px;">
                </select>
            </div>
            <div class="col-auto">
                <span class="text-muted">~</span>
            </div>
            <div class="col-auto">
                <select id="filterTo" class="form-select form-select-sm" style="width: 140px;">
                </select>
            </div>
            <div class="col-auto">
                <button id="btnApplyFilter" class="btn btn-primary btn-sm">
                    <i class="bi bi-funnel me-1"></i>적용
                </button>
                <button id="btnResetFilter" class="btn btn-outline-secondary btn-sm ms-1">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>전체보기
                </button>
            </div>
            <div class="col-auto ms-3">
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary quick-filter" data-months="12">1Y</button>
                    <button type="button" class="btn btn-outline-primary quick-filter" data-months="36">3Y</button>
                    <button type="button" class="btn btn-outline-primary quick-filter" data-months="60">5Y</button>
                    <button type="button" class="btn btn-outline-primary quick-filter active" data-months="0">All</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 차트 섹션 (위에 배치) -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header py-2">
                    <small class="fw-bold">Search Engine M/S (%, Desktop+Mobile)</small>
                </div>
                <div class="card-body p-2">
                    <div id="chartDesktopMobile" class="chart-container">
                        <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header py-2">
                    <small class="fw-bold">Search Engine M/S (%, Desktop)</small>
                </div>
                <div class="card-body p-2">
                    <div id="chartDesktop" class="chart-container">
                        <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header py-2">
                    <small class="fw-bold">Search Engine M/S (%, Mobile)</small>
                </div>
                <div class="card-body p-2">
                    <div id="chartMobile" class="chart-container">
                        <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 데이터 테이블 섹션 (아래에 배치) -->
    <div class="card">
        <div class="section-title">Search Engine M/S Data Table</div>
        <div class="card-body p-2">
            <!-- Desktop+Mobile 테이블 -->
            <div class="mb-3">
                <h6 class="text-muted mb-2"><i class="bi bi-display me-1"></i>Desktop + Mobile</h6>
                <div class="data-table" id="tableDesktopMobile">
                    <div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div> Loading...</div>
                </div>
            </div>

            <!-- Desktop 테이블 -->
            <div class="mb-3">
                <h6 class="text-muted mb-2"><i class="bi bi-pc-display me-1"></i>Desktop</h6>
                <div class="data-table" id="tableDesktop">
                    <div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div> Loading...</div>
                </div>
            </div>

            <!-- Mobile 테이블 -->
            <div class="mb-3">
                <h6 class="text-muted mb-2"><i class="bi bi-phone me-1"></i>Mobile</h6>
                <div class="data-table" id="tableMobile">
                    <div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div> Loading...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Plotly.js -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<script>
// 색상 설정 (첨부 이미지 참고)
const COLORS = {
    'Google': '#4285F4',   // Google Blue
    'Yahoo': '#6001d2',    // Yahoo Purple
    'Other': '#999999',    // Gray
    'Bing': '#f25022'      // Bing Red/Orange
};

// 전역 데이터 저장
let globalData = null;
let filteredData = null;

// 행 색상 클래스 매핑
function getRowClass(name) {
    if (name.includes('Google')) return 'bg-google';
    if (name.includes('Yahoo')) return 'bg-yahoo';
    if (name.includes('Bing')) return 'bg-bing';
    if (name.includes('Other')) return 'bg-other';
    return '';
}

// 날짜 필터 옵션 생성
function populateDateFilters(dates) {
    const fromSelect = document.getElementById('filterFrom');
    const toSelect = document.getElementById('filterTo');

    fromSelect.innerHTML = '';
    toSelect.innerHTML = '';

    dates.forEach((d, i) => {
        const optionFrom = document.createElement('option');
        optionFrom.value = d;
        optionFrom.text = d;
        if (i === 0) optionFrom.selected = true;
        fromSelect.appendChild(optionFrom);

        const optionTo = document.createElement('option');
        optionTo.value = d;
        optionTo.text = d;
        if (i === dates.length - 1) optionTo.selected = true;
        toSelect.appendChild(optionTo);
    });
}

// 데이터 필터링
function filterDataByDateRange(data, fromDate, toDate) {
    if (!data || !data.dates) return data;

    const fromIdx = data.dates.indexOf(fromDate);
    const toIdx = data.dates.indexOf(toDate);

    if (fromIdx === -1 || toIdx === -1 || fromIdx > toIdx) return data;

    const filtered = {
        dates: data.dates.slice(fromIdx, toIdx + 1)
    };

    ['Google', 'Yahoo', 'Other', 'Bing'].forEach(engine => {
        if (data[engine]) {
            filtered[engine] = data[engine].slice(fromIdx, toIdx + 1);
        }
    });

    return filtered;
}

// 테이블 생성 함수 (필터된 기간 전체 표시)
function createTable(containerId, data, suffix) {
    const container = document.getElementById(containerId);
    if (!data || !data.dates || data.dates.length === 0) {
        container.innerHTML = '<p class="text-muted text-center py-3">No data available</p>';
        return;
    }

    const dates = data.dates;
    // 주요 검색엔진만 필터링
    const engines = ['Google', 'Yahoo', 'Other', 'Bing'].filter(e => data[e]);

    let html = '<div style="overflow-x:auto;"><table><thead><tr><th></th>';

    // 필터된 데이터 전체 표시 (차트와 동일)
    dates.forEach(d => {
        html += `<th>${d}</th>`;
    });
    html += '</tr></thead><tbody>';

    engines.forEach(engine => {
        const rowClass = getRowClass(engine);
        html += `<tr class="${rowClass}"><td>${engine} (${suffix})</td>`;

        data[engine].forEach(v => {
            const displayVal = v !== null ? v.toFixed(1) : '-';
            html += `<td>${displayVal}</td>`;
        });
        html += '</tr>';
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// 스택형 바 차트 생성 함수 (개선된 x축)
function createStackedBarChart(containerId, data, title) {
    const container = document.getElementById(containerId);
    if (!data || !data.dates || data.dates.length === 0) {
        container.innerHTML = '<p class="text-muted text-center py-5">No data available</p>';
        return;
    }

    // 주요 검색엔진만 사용 (순서: Google, Yahoo, Other, Bing - 스택 순서)
    const engines = ['Bing', 'Other', 'Yahoo', 'Google'].filter(e => data[e]);

    const traces = engines.map(engine => ({
        x: data.dates,
        y: data[engine].map(v => v || 0),
        name: engine,
        type: 'bar',
        marker: { color: COLORS[engine] || '#888' }
    }));

    // x축 tick 간격 계산 (데이터 개수에 따라 동적 조정)
    const dataLength = data.dates.length;
    let dtick = 12; // 기본 12개월(1년) 간격
    if (dataLength <= 24) dtick = 3;      // 2년 이하면 3개월 간격
    else if (dataLength <= 60) dtick = 6; // 5년 이하면 6개월 간격
    else if (dataLength <= 120) dtick = 12; // 10년 이하면 12개월 간격
    else dtick = 24; // 그 이상이면 24개월 간격

    const layout = {
        barmode: 'stack',
        margin: { t: 10, b: 80, l: 40, r: 10 },
        xaxis: {
            tickangle: -45,
            tickfont: { size: 9 },
            dtick: dtick,
            tickformat: '%Y-%m',
            type: 'category'
        },
        yaxis: {
            title: '%',
            range: [0, 100],
            tickformat: '.0f'
        },
        legend: {
            orientation: 'h',
            y: -0.25,
            x: 0.5,
            xanchor: 'center',
            font: { size: 10 }
        },
        showlegend: true
    };

    Plotly.newPlot(containerId, traces, layout, {responsive: true, displayModeBar: false});
}

// 모든 차트와 테이블 렌더링
function renderAll(data) {
    if (!data) return;

    // 테이블 생성
    createTable('tableDesktopMobile', data.desktop_mobile, 'Desktop+Mobile');
    createTable('tableDesktop', data.desktop, 'Desktop');
    createTable('tableMobile', data.mobile, 'Mobile');

    // 차트 생성
    createStackedBarChart('chartDesktopMobile', data.desktop_mobile);
    createStackedBarChart('chartDesktop', data.desktop);
    createStackedBarChart('chartMobile', data.mobile);
}

// 필터 적용
function applyFilter() {
    const fromDate = document.getElementById('filterFrom').value;
    const toDate = document.getElementById('filterTo').value;

    if (!globalData) return;

    filteredData = {
        desktop_mobile: filterDataByDateRange(globalData.desktop_mobile, fromDate, toDate),
        desktop: filterDataByDateRange(globalData.desktop, fromDate, toDate),
        mobile: filterDataByDateRange(globalData.mobile, fromDate, toDate)
    };

    renderAll(filteredData);
}

// 필터 리셋
function resetFilter() {
    if (!globalData) return;

    // 날짜 선택기 리셋
    const dates = globalData.desktop_mobile.dates;
    document.getElementById('filterFrom').value = dates[0];
    document.getElementById('filterTo').value = dates[dates.length - 1];

    // Quick filter 버튼 리셋
    document.querySelectorAll('.quick-filter').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.months === '0') btn.classList.add('active');
    });

    renderAll(globalData);
}

// Quick filter 적용
function applyQuickFilter(months) {
    if (!globalData || !globalData.desktop_mobile.dates) return;

    const dates = globalData.desktop_mobile.dates;
    const toDate = dates[dates.length - 1];

    let fromDate;
    if (months === 0) {
        fromDate = dates[0]; // All data
    } else {
        const fromIdx = Math.max(0, dates.length - months);
        fromDate = dates[fromIdx];
    }

    document.getElementById('filterFrom').value = fromDate;
    document.getElementById('filterTo').value = toDate;

    applyFilter();
}

// 이벤트 리스너 설정
document.getElementById('btnApplyFilter').addEventListener('click', applyFilter);
document.getElementById('btnResetFilter').addEventListener('click', resetFilter);

document.querySelectorAll('.quick-filter').forEach(btn => {
    btn.addEventListener('click', function() {
        // 활성 상태 토글
        document.querySelectorAll('.quick-filter').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        const months = parseInt(this.dataset.months);
        applyQuickFilter(months);
    });
});

// 데이터 로드 및 렌더링
fetch('/api/search-engine/all')
    .then(res => res.json())
    .then(data => {
        globalData = data;

        // 날짜 필터 옵션 생성
        if (data.desktop_mobile && data.desktop_mobile.dates) {
            populateDateFilters(data.desktop_mobile.dates);
        }

        // 초기 렌더링
        renderAll(data);
    })
    .catch(err => {
        console.error('Error:', err);
        ['tableDesktopMobile', 'tableDesktop', 'tableMobile'].forEach(id => {
            document.getElementById(id).innerHTML = '<p class="text-danger text-center py-3">Failed to load data</p>';
        });
        ['chartDesktopMobile', 'chartDesktop', 'chartMobile'].forEach(id => {
            document.getElementById(id).innerHTML = '<p class="text-danger text-center py-5">Failed to load chart</p>';
        });
    });
</script>
{% endblock %}
