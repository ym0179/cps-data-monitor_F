{% extends "base.html" %}

{% block title %}Search Engine M/S - Market Data{% endblock %}

{% block extra_css %}
<style>
    /* 데이터 테이블 스타일 */
    .data-table {
        font-size: 11px;
        overflow-x: auto;
    }
    .data-table table {
        min-width: 100%;
        border-collapse: collapse;
        width: 100%;
    }
    .data-table th, .data-table td {
        padding: 6px 8px;
        text-align: center;
        border: 1px solid #e5e7eb;
        white-space: nowrap;
    }
    .data-table th {
        background: #f9fafb;
        font-weight: 600;
        position: sticky;
        left: 0;
        z-index: 1;
    }
    .data-table td:first-child {
        position: sticky;
        left: 0;
        background: #fff;
        font-weight: 500;
        z-index: 1;
    }
    /* 색상 포맷팅 */
    .bg-google { background-color: #c6efce !important; color: #006100; }
    .bg-yahoo { background-color: #f2f2f2 !important; }
    .bg-other { background-color: #fafafa !important; }
    .bg-bing { background-color: #ffc7ce !important; color: #9c0006; }

    .chart-container {
        height: 320px;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- 헤더 -->
    <div>
        <div class="flex items-center space-x-2">
            <h1 class="text-3xl font-semibold text-gray-900">Search Engine Market Share</h1>
            <i class="bi bi-info-circle text-gray-400 w-4 h-4"></i>
        </div>
        <p class="text-gray-600 mt-1 text-sm">
            Market share percentage by search engine • Data Source: <a href="https://gs.statcounter.com/search-engine-market-share" target="_blank" class="text-blue-600 hover:underline">StatCounter Global Stats</a> (Jan 2019 ~ Present)
        </p>
    </div>

    <!-- 필터 섹션 -->
    <div class="card-custom">
        <div class="p-4">
            <div class="flex flex-wrap items-center gap-3">
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">
                        <i class="bi bi-calendar-range mr-1"></i>기간 선택:
                    </label>
                    <input type="text" id="filterFrom" class="px-3 py-1.5 border border-gray-300 rounded-md text-sm w-24 text-center" list="dateListFrom" placeholder="YYYY-MM">
                    <datalist id="dateListFrom"></datalist>
                    <span class="text-gray-500">~</span>
                    <input type="text" id="filterTo" class="px-3 py-1.5 border border-gray-300 rounded-md text-sm w-24 text-center" list="dateListTo" placeholder="YYYY-MM">
                    <datalist id="dateListTo"></datalist>
                </div>
                <button id="btnApplyFilter" class="btn-custom btn-custom-default btn-custom-sm">
                    <i class="bi bi-funnel"></i> 적용
                </button>
                <button id="btnResetFilter" class="btn-custom btn-custom-outline btn-custom-sm">
                    <i class="bi bi-arrow-counterclockwise"></i> 전체보기
                </button>
                <div class="flex items-center bg-gray-100 rounded-md p-1 ml-2">
                    <button type="button" class="quick-filter px-3 py-1 text-xs font-medium rounded transition-colors hover:bg-white hover:shadow-sm" data-months="12">1Y</button>
                    <button type="button" class="quick-filter px-3 py-1 text-xs font-medium rounded transition-colors hover:bg-white hover:shadow-sm" data-months="36">3Y</button>
                    <button type="button" class="quick-filter px-3 py-1 text-xs font-medium rounded transition-colors hover:bg-white hover:shadow-sm" data-months="60">5Y</button>
                    <button type="button" class="quick-filter active px-3 py-1 text-xs font-medium rounded bg-white shadow-sm" data-months="0">All</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 차트 섹션 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card-custom">
            <div class="px-6 pt-6">
                <h4 class="font-medium text-gray-900">Desktop+Mobile</h4>
                <p class="text-xs text-gray-500 mt-0.5">Combined market share (%)</p>
            </div>
            <div class="px-6 pb-6">
                <div id="chartDesktopMobile" class="chart-container">
                    <div class="flex items-center justify-center h-full">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-custom">
            <div class="px-6 pt-6">
                <h4 class="font-medium text-gray-900">Desktop</h4>
                <p class="text-xs text-gray-500 mt-0.5">Desktop only (%)</p>
            </div>
            <div class="px-6 pb-6">
                <div id="chartDesktop" class="chart-container">
                    <div class="flex items-center justify-center h-full">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-custom">
            <div class="px-6 pt-6">
                <h4 class="font-medium text-gray-900">Mobile</h4>
                <p class="text-xs text-gray-500 mt-0.5">Mobile only (%)</p>
            </div>
            <div class="px-6 pb-6">
                <div id="chartMobile" class="chart-container">
                    <div class="flex items-center justify-center h-full">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 데이터 테이블 섹션 -->
    <div class="card-custom">
        <div class="flex items-center justify-between px-6 pt-6">
            <div>
                <h4 class="font-medium text-gray-900">Data Table</h4>
                <p class="text-xs text-gray-500 mt-0.5">Detailed market share data</p>
            </div>
            <a href="/api/search-engine/download" class="btn-custom btn-custom-outline btn-custom-sm">
                <i class="bi bi-download"></i> Export
            </a>
        </div>
        <div class="px-6 pb-6">
            <!-- Desktop+Mobile 테이블 -->
            <div class="mb-4 mt-4">
                <h6 class="text-sm font-medium text-gray-700 mb-2">
                    <i class="bi bi-display mr-1"></i>Desktop + Mobile
                </h6>
                <div class="data-table" id="tableDesktopMobile">
                    <div class="flex items-center justify-center py-8">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-gray-900"></div>
                    </div>
                </div>
            </div>

            <!-- Desktop 테이블 -->
            <div class="mb-4">
                <h6 class="text-sm font-medium text-gray-700 mb-2">
                    <i class="bi bi-pc-display mr-1"></i>Desktop
                </h6>
                <div class="data-table" id="tableDesktop">
                    <div class="flex items-center justify-center py-8">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-gray-900"></div>
                    </div>
                </div>
            </div>

            <!-- Mobile 테이블 -->
            <div>
                <h6 class="text-sm font-medium text-gray-700 mb-2">
                    <i class="bi bi-phone mr-1"></i>Mobile
                </h6>
                <div class="data-table" id="tableMobile">
                    <div class="flex items-center justify-center py-8">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-gray-900"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="px-6 pb-6 text-xs text-gray-500 border-t pt-4 mt-2">
            <p>Last updated: <span id="lastUpdated"></span></p>
        </div>
    </div>
</div>

<!-- Plotly.js -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<script>
// 색상 설정
const COLORS = {
    'Google': '#4285F4',
    'Yahoo': '#808080',
    'Other': '#C0C0C0',
    'Bing': '#EA4335'
};

// 전역 데이터 저장
let globalData = null;
let allDates = [];

// 행 색상 클래스 매핑
function getRowClass(name) {
    if (name.includes('Google')) return 'bg-google';
    if (name.includes('Yahoo')) return 'bg-yahoo';
    if (name.includes('Bing')) return 'bg-bing';
    if (name.includes('Other')) return 'bg-other';
    return '';
}

// 날짜 필터 datalist 생성
function populateDateFilters(dates) {
    allDates = dates;
    const fromList = document.getElementById('dateListFrom');
    const toList = document.getElementById('dateListTo');

    fromList.innerHTML = '';
    toList.innerHTML = '';

    dates.forEach(d => {
        fromList.innerHTML += `<option value="${d}">`;
        toList.innerHTML += `<option value="${d}">`;
    });

    document.getElementById('filterFrom').value = dates[0];
    document.getElementById('filterTo').value = dates[dates.length - 1];
}

// 데이터 필터링
function filterDataByDateRange(data, fromDate, toDate) {
    if (!data || !data.dates) return data;

    const fromIdx = data.dates.indexOf(fromDate);
    const toIdx = data.dates.indexOf(toDate);

    if (fromIdx === -1 || toIdx === -1 || fromIdx > toIdx) return data;

    const filtered = {
        dates: data.dates.slice(fromIdx, toIdx + 1)
    };

    ['Google', 'Yahoo', 'Other', 'Bing'].forEach(engine => {
        if (data[engine]) {
            filtered[engine] = data[engine].slice(fromIdx, toIdx + 1);
        }
    });

    return filtered;
}

// 테이블 생성 함수
function createTable(containerId, data, suffix) {
    const container = document.getElementById(containerId);
    if (!data || !data.dates || data.dates.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 py-4">No data available</p>';
        return;
    }

    const dates = data.dates;
    const engines = ['Google', 'Yahoo', 'Other', 'Bing'].filter(e => data[e]);

    let html = '<div style="overflow-x:auto;"><table><thead><tr><th></th>';

    dates.forEach(d => {
        html += `<th>${d}</th>`;
    });
    html += '</tr></thead><tbody>';

    engines.forEach(engine => {
        const rowClass = getRowClass(engine);
        html += `<tr class="${rowClass}"><td>${engine} (${suffix})</td>`;

        data[engine].forEach(v => {
            const displayVal = v !== null ? v.toFixed(2) : '-';
            html += `<td>${displayVal}</td>`;
        });
        html += '</tr>';
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// 스택형 막대 차트 생성
function createStackedBarChart(containerId, data) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';

    if (!data || !data.dates || data.dates.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 flex items-center justify-center h-full">No data available</p>';
        return;
    }

    const engines = ['Bing', 'Other', 'Yahoo', 'Google'].filter(e => data[e]);

    try {
        const traces = engines.map(engine => ({
            x: data.dates,
            y: data[engine].map(v => v || 0),
            name: engine,
            type: 'bar',
            marker: { color: COLORS[engine] },
            hovertemplate: '%{fullData.name}<br>%{x}<br>%{y:.2f}%<extra></extra>'
        }));

        const dataLength = data.dates.length;
        let dtick = 6;
        if (dataLength <= 24) dtick = 3;
        else if (dataLength <= 48) dtick = 6;
        else dtick = 12;

        const layout = {
            barmode: 'stack',
            margin: { t: 10, b: 60, l: 40, r: 10 },
            xaxis: {
                tickangle: -45,
                tickfont: { size: 9 },
                dtick: dtick,
                type: 'category'
            },
            yaxis: {
                title: '%',
                range: [0, 100],
                tickformat: '.0f'
            },
            legend: {
                orientation: 'h',
                y: -0.25,
                x: 0.5,
                xanchor: 'center',
                font: { size: 10 }
            },
            showlegend: true,
            hovermode: 'x unified',
            paper_bgcolor: 'white',
            plot_bgcolor: 'white'
        };

        const config = {
            responsive: true,
            displayModeBar: false
        };

        Plotly.newPlot(containerId, traces, layout, config);
    } catch (err) {
        console.error('Chart creation error:', err);
        container.innerHTML = '<p class="text-center text-red-600 flex items-center justify-center h-full">차트 생성 오류</p>';
    }
}

// 모든 차트와 테이블 렌더링
function renderAll(data) {
    if (!data) return;

    createTable('tableDesktopMobile', data.desktop_mobile, 'Desktop+Mobile');
    createTable('tableDesktop', data.desktop, 'Desktop');
    createTable('tableMobile', data.mobile, 'Mobile');

    setTimeout(() => {
        createStackedBarChart('chartDesktopMobile', data.desktop_mobile);
        createStackedBarChart('chartDesktop', data.desktop);
        createStackedBarChart('chartMobile', data.mobile);
    }, 50);

    // Last updated 설정
    const now = new Date();
    document.getElementById('lastUpdated').textContent = now.toLocaleString('ko-KR');
}

// 필터 적용
function applyFilter() {
    const fromDate = document.getElementById('filterFrom').value;
    const toDate = document.getElementById('filterTo').value;

    if (!globalData) return;

    if (!allDates.includes(fromDate) || !allDates.includes(toDate)) {
        alert('유효한 날짜를 입력해주세요. (예: 2019-01)');
        return;
    }

    const filteredData = {
        desktop_mobile: filterDataByDateRange(globalData.desktop_mobile, fromDate, toDate),
        desktop: filterDataByDateRange(globalData.desktop, fromDate, toDate),
        mobile: filterDataByDateRange(globalData.mobile, fromDate, toDate)
    };

    renderAll(filteredData);
}

// 필터 리셋
function resetFilter() {
    if (!globalData || !globalData.desktop_mobile.dates) return;

    const dates = globalData.desktop_mobile.dates;
    document.getElementById('filterFrom').value = dates[0];
    document.getElementById('filterTo').value = dates[dates.length - 1];

    document.querySelectorAll('.quick-filter').forEach(btn => {
        btn.classList.remove('active', 'bg-white', 'shadow-sm');
        if (btn.dataset.months === '0') {
            btn.classList.add('active', 'bg-white', 'shadow-sm');
        }
    });

    renderAll(globalData);
}

// Quick filter 적용
function applyQuickFilter(months) {
    if (!globalData || !globalData.desktop_mobile.dates) return;

    const dates = globalData.desktop_mobile.dates;
    const toDate = dates[dates.length - 1];

    let fromDate;
    if (months === 0) {
        fromDate = dates[0];
    } else {
        const fromIdx = Math.max(0, dates.length - months);
        fromDate = dates[fromIdx];
    }

    document.getElementById('filterFrom').value = fromDate;
    document.getElementById('filterTo').value = toDate;

    applyFilter();
}

// 이벤트 리스너
document.getElementById('btnApplyFilter').addEventListener('click', applyFilter);
document.getElementById('btnResetFilter').addEventListener('click', resetFilter);

document.querySelectorAll('.quick-filter').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.quick-filter').forEach(b => {
            b.classList.remove('active', 'bg-white', 'shadow-sm');
        });
        this.classList.add('active', 'bg-white', 'shadow-sm');
        applyQuickFilter(parseInt(this.dataset.months));
    });
});

document.getElementById('filterFrom').addEventListener('keypress', e => { if (e.key === 'Enter') applyFilter(); });
document.getElementById('filterTo').addEventListener('keypress', e => { if (e.key === 'Enter') applyFilter(); });

// 데이터 로드
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 30000);

fetch('/api/search-engine/all', { signal: controller.signal })
    .then(res => {
        clearTimeout(timeoutId);
        if (!res.ok) throw new Error('API Error: ' + res.status);
        return res.json();
    })
    .then(data => {
        console.log('Data loaded:', data);
        globalData = data;

        if (data.desktop_mobile && data.desktop_mobile.dates && data.desktop_mobile.dates.length > 0) {
            populateDateFilters(data.desktop_mobile.dates);
            renderAll(data);
        } else {
            throw new Error('No data in response');
        }
    })
    .catch(err => {
        clearTimeout(timeoutId);
        console.error('Error:', err);
        let errorMsg = '<p class="text-center text-red-600 py-4">데이터 로드 실패</p>';
        ['tableDesktopMobile', 'tableDesktop', 'tableMobile', 'chartDesktopMobile', 'chartDesktop', 'chartMobile'].forEach(id => {
            document.getElementById(id).innerHTML = errorMsg;
        });
    });
</script>
{% endblock %}
