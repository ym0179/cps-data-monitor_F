{% extends "base.html" %}

{% block title %}Market Data - 고객상품전략팀{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="mb-1"><i class="bi bi-bar-chart-fill text-info me-2"></i>Market Data (Global Market Share)</h4>
            <p class="text-muted mb-0">Data Source: StatCounter Global Stats</p>
        </div>
        <a href="/market/search-engine" class="btn btn-success btn-sm">
            <i class="bi bi-search me-1"></i>Search Engine M/S
        </a>
    </div>

    <!-- 탭 메뉴 -->
    <ul class="nav nav-tabs mb-4" id="marketTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="browser-tab" data-bs-toggle="tab" data-bs-target="#browser" type="button">
                <i class="bi bi-globe me-1"></i>Browser Market Share
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="os-tab" data-bs-toggle="tab" data-bs-target="#os" type="button">
                <i class="bi bi-phone me-1"></i>OS Market Share
            </button>
        </li>
    </ul>

    <div class="tab-content" id="marketTabContent">
        <!-- Browser Tab -->
        <div class="tab-pane fade show active" id="browser" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header">
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="browserDevice" id="browserAll" value="desktop" checked>
                        <label class="btn btn-outline-primary btn-sm" for="browserAll">Desktop</label>
                        <input type="radio" class="btn-check" name="browserDevice" id="browserMobile" value="mobile">
                        <label class="btn btn-outline-primary btn-sm" for="browserMobile">Mobile</label>
                    </div>
                </div>
                <div class="card-body">
                    <div id="browserChart" style="height: 400px;">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">Loading data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- OS Tab -->
        <div class="tab-pane fade" id="os" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header">
                    <span class="fw-bold">Android vs iOS Rivalry</span>
                    <div class="btn-group ms-3" role="group">
                        <input type="radio" class="btn-check" name="osDevice" id="osMobile" value="mobile" checked>
                        <label class="btn btn-outline-primary btn-sm" for="osMobile">Mobile</label>
                        <input type="radio" class="btn-check" name="osDevice" id="osTablet" value="tablet">
                        <label class="btn btn-outline-primary btn-sm" for="osTablet">Tablet</label>
                    </div>
                </div>
                <div class="card-body">
                    <div id="osChart" style="height: 400px;">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">Loading data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Plotly.js -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<script>
// Browser Chart
function loadBrowserChart(device) {
    fetch(`/api/statcounter/browser?device=${device}`)
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                document.getElementById('browserChart').innerHTML = '<p class="text-danger text-center py-5">Failed to load data</p>';
                return;
            }

            const traces = [];
            const colors = {
                'Chrome': '#4285F4',
                'Safari': '#FF9500',
                'Firefox': '#FF7139',
                'Edge': '#0078D7',
                'Samsung Internet': '#1428A0',
                'Opera': '#FF1B2D'
            };

            // 유효한 날짜 범위 찾기 (모든 시리즈에 데이터가 있는 범위)
            let maxValidIndex = data.dates.length - 1;
            for (const [name, values] of Object.entries(data.series)) {
                for (let i = values.length - 1; i >= 0; i--) {
                    if (values[i] !== null && values[i] !== undefined && !isNaN(values[i])) {
                        if (i < maxValidIndex) maxValidIndex = i;
                        break;
                    }
                }
            }

            // 유효한 데이터만 사용
            const validDates = data.dates.slice(0, maxValidIndex + 1);

            for (const [name, values] of Object.entries(data.series)) {
                const validValues = values.slice(0, maxValidIndex + 1).map(v =>
                    (v !== null && v !== undefined && !isNaN(v)) ? v : 0
                );

                traces.push({
                    x: validDates,
                    y: validValues,
                    name: name,
                    type: 'scatter',
                    mode: 'lines',
                    line: { width: 2, color: colors[name] || undefined },
                    stackgroup: 'one'
                });
            }

            const layout = {
                title: `Browser Market Share (${device})`,
                xaxis: { title: 'Date' },
                yaxis: { title: 'Market Share (%)', range: [0, 100] },
                hovermode: 'x unified',
                legend: { orientation: 'h', y: -0.2 }
            };

            Plotly.newPlot('browserChart', traces, layout, {responsive: true});
        })
        .catch(err => {
            document.getElementById('browserChart').innerHTML = '<p class="text-danger text-center py-5">Error loading data</p>';
        });
}

// OS Chart
function loadOSChart(device) {
    fetch(`/api/os-rivalry?device=${device}`)
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                document.getElementById('osChart').innerHTML = '<p class="text-danger text-center py-5">Failed to load data</p>';
                return;
            }

            const traces = [];
            const colors = { 'Android': '#3DDC84', 'iOS': '#555555' };

            for (const [name, values] of Object.entries(data.series)) {
                // null/NaN 값을 필터링하고 유효한 데이터만 사용
                const validData = [];
                const validDates = [];
                for (let i = 0; i < values.length; i++) {
                    if (values[i] !== null && values[i] !== undefined && !isNaN(values[i]) && values[i] > 0) {
                        validData.push(values[i]);
                        validDates.push(data.dates[i]);
                    }
                }

                traces.push({
                    x: validDates,
                    y: validData,
                    name: name,
                    type: 'scatter',
                    mode: 'lines',
                    line: { width: 3, color: colors[name] },
                    connectgaps: false  // null 값에서 선 끊기
                });
            }

            const layout = {
                title: `Mobile OS Market Share (${device})`,
                xaxis: { title: 'Date' },
                yaxis: { title: 'Market Share (%)', range: [0, 100] },
                hovermode: 'x unified',
                legend: { orientation: 'h', y: -0.2 }
            };

            Plotly.newPlot('osChart', traces, layout, {responsive: true});
        })
        .catch(err => {
            document.getElementById('osChart').innerHTML = '<p class="text-danger text-center py-5">Error loading data</p>';
        });
}

// Event Listeners
document.querySelectorAll('input[name="browserDevice"]').forEach(radio => {
    radio.addEventListener('change', (e) => loadBrowserChart(e.target.value));
});

document.querySelectorAll('input[name="osDevice"]').forEach(radio => {
    radio.addEventListener('change', (e) => loadOSChart(e.target.value));
});

// Tab change listener
document.getElementById('os-tab').addEventListener('shown.bs.tab', () => {
    const device = document.querySelector('input[name="osDevice"]:checked').value;
    loadOSChart(device);
});

// Initial load
loadBrowserChart('desktop');
</script>
{% endblock %}
