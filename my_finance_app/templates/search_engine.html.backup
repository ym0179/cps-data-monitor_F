{% extends "base.html" %}

{% block title %}Search Engine M/S - Market Data{% endblock %}

{% block extra_css %}
<style>
    .data-table {
        font-size: 11px;
        overflow-x: auto;
    }
    .data-table table {
        min-width: 100%;
        border-collapse: collapse;
    }
    .data-table th, .data-table td {
        padding: 4px 6px;
        text-align: center;
        border: 1px solid #ddd;
        white-space: nowrap;
    }
    .data-table th {
        background: #f5f5f5;
        font-weight: 600;
        position: sticky;
        left: 0;
        z-index: 1;
    }
    .data-table td:first-child {
        position: sticky;
        left: 0;
        background: #fff;
        font-weight: 500;
        z-index: 1;
    }
    /* 색상 포맷팅 */
    .bg-google { background-color: #c6efce !important; color: #006100; }
    .bg-yahoo { background-color: #f2f2f2 !important; }
    .bg-other { background-color: #fafafa !important; }
    .bg-bing { background-color: #ffc7ce !important; color: #9c0006; }

    .section-title {
        background: linear-gradient(90deg, #198754 0%, #20c997 100%);
        color: white;
        padding: 8px 15px;
        font-weight: 600;
        margin-bottom: 0;
    }
    .chart-container {
        height: 400px;
    }
    .filter-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    /* 날짜 입력 스타일 */
    .date-input {
        width: 100px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-3">
    <!-- 헤더 -->
    <div class="mb-3">
        <h4 class="mb-1"><i class="bi bi-search text-success me-2"></i>Search Engine M/S</h4>
        <p class="text-muted mb-0">
            <small>Data Source: <a href="https://gs.statcounter.com/search-engine-market-share" target="_blank">StatCounter Global Stats</a> (Jan 2019 ~ Present)</small>
        </p>
    </div>

    <!-- 날짜 필터 섹션 -->
    <div class="filter-section">
        <div class="row align-items-center">
            <div class="col-auto">
                <label class="form-label mb-0 fw-bold"><i class="bi bi-calendar-range me-1"></i>기간 선택:</label>
            </div>
            <div class="col-auto">
                <input type="text" id="filterFrom" class="form-control form-control-sm date-input" list="dateListFrom" placeholder="YYYY-MM">
                <datalist id="dateListFrom"></datalist>
            </div>
            <div class="col-auto">
                <span class="text-muted">~</span>
            </div>
            <div class="col-auto">
                <input type="text" id="filterTo" class="form-control form-control-sm date-input" list="dateListTo" placeholder="YYYY-MM">
                <datalist id="dateListTo"></datalist>
            </div>
            <div class="col-auto">
                <button id="btnApplyFilter" class="btn btn-primary btn-sm">
                    <i class="bi bi-funnel me-1"></i>적용
                </button>
                <button id="btnResetFilter" class="btn btn-outline-secondary btn-sm ms-1">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>전체보기
                </button>
            </div>
            <div class="col-auto ms-3">
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary quick-filter" data-months="12">1Y</button>
                    <button type="button" class="btn btn-outline-primary quick-filter" data-months="36">3Y</button>
                    <button type="button" class="btn btn-outline-primary quick-filter" data-months="60">5Y</button>
                    <button type="button" class="btn btn-outline-primary quick-filter active" data-months="0">All</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 차트 섹션 (위에 배치) -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header py-2">
                    <small class="fw-bold">Search Engine M/S (%, Desktop+Mobile)</small>
                </div>
                <div class="card-body p-2">
                    <div id="chartDesktopMobile" class="chart-container">
                        <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header py-2">
                    <small class="fw-bold">Search Engine M/S (%, Desktop)</small>
                </div>
                <div class="card-body p-2">
                    <div id="chartDesktop" class="chart-container">
                        <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header py-2">
                    <small class="fw-bold">Search Engine M/S (%, Mobile)</small>
                </div>
                <div class="card-body p-2">
                    <div id="chartMobile" class="chart-container">
                        <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 데이터 테이블 섹션 (아래에 배치) -->
    <div class="card">
        <div class="section-title d-flex justify-content-between align-items-center">
            <span>Search Engine M/S Data Table</span>
            <a href="/api/search-engine/download" class="btn btn-light btn-sm">
                <i class="bi bi-file-earmark-excel me-1"></i>Excel 다운로드
            </a>
        </div>
        <div class="card-body p-2">
            <!-- Desktop+Mobile 테이블 -->
            <div class="mb-3">
                <h6 class="text-muted mb-2"><i class="bi bi-display me-1"></i>Desktop + Mobile</h6>
                <div class="data-table" id="tableDesktopMobile">
                    <div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div> Loading...</div>
                </div>
            </div>

            <!-- Desktop 테이블 -->
            <div class="mb-3">
                <h6 class="text-muted mb-2"><i class="bi bi-pc-display me-1"></i>Desktop</h6>
                <div class="data-table" id="tableDesktop">
                    <div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div> Loading...</div>
                </div>
            </div>

            <!-- Mobile 테이블 -->
            <div class="mb-3">
                <h6 class="text-muted mb-2"><i class="bi bi-phone me-1"></i>Mobile</h6>
                <div class="data-table" id="tableMobile">
                    <div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div> Loading...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Plotly.js -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<script>
// 색상 설정 (첨부 이미지와 동일하게)
const COLORS = {
    'Google': '#4285F4',   // Google Blue (파란색)
    'Yahoo': '#808080',    // Gray (회색)
    'Other': '#C0C0C0',    // Light Gray (연회색)
    'Bing': '#EA4335'      // Red (빨간색)
};

// 전역 데이터 저장
let globalData = null;
let allDates = [];

// 행 색상 클래스 매핑
function getRowClass(name) {
    if (name.includes('Google')) return 'bg-google';
    if (name.includes('Yahoo')) return 'bg-yahoo';
    if (name.includes('Bing')) return 'bg-bing';
    if (name.includes('Other')) return 'bg-other';
    return '';
}

// 날짜 필터 datalist 생성
function populateDateFilters(dates) {
    allDates = dates;
    const fromList = document.getElementById('dateListFrom');
    const toList = document.getElementById('dateListTo');

    fromList.innerHTML = '';
    toList.innerHTML = '';

    dates.forEach(d => {
        fromList.innerHTML += `<option value="${d}">`;
        toList.innerHTML += `<option value="${d}">`;
    });

    // 초기값 설정
    document.getElementById('filterFrom').value = dates[0];
    document.getElementById('filterTo').value = dates[dates.length - 1];
}

// 데이터 필터링
function filterDataByDateRange(data, fromDate, toDate) {
    if (!data || !data.dates) return data;

    const fromIdx = data.dates.indexOf(fromDate);
    const toIdx = data.dates.indexOf(toDate);

    if (fromIdx === -1 || toIdx === -1 || fromIdx > toIdx) return data;

    const filtered = {
        dates: data.dates.slice(fromIdx, toIdx + 1)
    };

    ['Google', 'Yahoo', 'Other', 'Bing'].forEach(engine => {
        if (data[engine]) {
            filtered[engine] = data[engine].slice(fromIdx, toIdx + 1);
        }
    });

    return filtered;
}

// 테이블 생성 함수 (소수점 2자리)
function createTable(containerId, data, suffix) {
    const container = document.getElementById(containerId);
    if (!data || !data.dates || data.dates.length === 0) {
        container.innerHTML = '<p class="text-muted text-center py-3">No data available</p>';
        return;
    }

    const dates = data.dates;
    const engines = ['Google', 'Yahoo', 'Other', 'Bing'].filter(e => data[e]);

    let html = '<div style="overflow-x:auto;"><table><thead><tr><th></th>';

    dates.forEach(d => {
        html += `<th>${d}</th>`;
    });
    html += '</tr></thead><tbody>';

    engines.forEach(engine => {
        const rowClass = getRowClass(engine);
        html += `<tr class="${rowClass}"><td>${engine} (${suffix})</td>`;

        data[engine].forEach(v => {
            const displayVal = v !== null ? v.toFixed(2) : '-';
            html += `<td>${displayVal}</td>`;
        });
        html += '</tr>';
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// 로딩 스피너 제거
function clearLoading(containerId) {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = '';
    }
}

// 차트 렌더링 타임아웃 ID (경합 조건 방지)
let chartRenderTimeout = null;

// 스택형 막대 차트 생성 (이미지와 동일한 스타일)
function createStackedBarChart(containerId, data) {
    const container = document.getElementById(containerId);

    // 먼저 로딩 스피너 제거
    container.innerHTML = '';

    if (!data || !data.dates || data.dates.length === 0) {
        container.innerHTML = '<p class="text-muted text-center py-5">No data available</p>';
        return;
    }

    // 스택 순서: 아래부터 Bing, Other, Yahoo, Google (위로 갈수록 큰 값)
    const engines = ['Bing', 'Other', 'Yahoo', 'Google'].filter(e => data[e]);

    try {
        const traces = engines.map(engine => ({
            x: data.dates,
            y: data[engine].map(v => v || 0),
            name: engine,
            type: 'bar',
            marker: { color: COLORS[engine] }
        }));

        // x축 tick 간격 계산
        const dataLength = data.dates.length;
        let dtick = 6;
        if (dataLength <= 24) dtick = 3;
        else if (dataLength <= 48) dtick = 6;
        else dtick = 12;

        const layout = {
            barmode: 'stack',
            margin: { t: 10, b: 80, l: 40, r: 10 },
            xaxis: {
                tickangle: -45,
                tickfont: { size: 9 },
                dtick: dtick,
                type: 'category'
            },
            yaxis: {
                title: '%',
                range: [0, 100],
                tickformat: '.0f'
            },
            legend: {
                orientation: 'h',
                y: -0.3,
                x: 0.5,
                xanchor: 'center',
                font: { size: 10 }
            },
            showlegend: true,
            hovermode: 'x unified'
        };

        const config = {
            responsive: true,
            displayModeBar: false
        };

        // 각 trace에 hovertemplate 추가 (소수점 2자리)
        traces.forEach(trace => {
            trace.hovertemplate = '%{fullData.name}<br>%{x}<br>%{y:.2f}%<extra></extra>';
        });

        Plotly.newPlot(containerId, traces, layout, config)
            .catch(err => {
                console.error('Plotly render error:', err);
                container.innerHTML = '<p class="text-danger text-center py-5">차트 렌더링 실패</p>';
            });
    } catch (err) {
        console.error('Chart creation error:', err);
        container.innerHTML = '<p class="text-danger text-center py-5">차트 생성 오류</p>';
    }
}

// 모든 차트와 테이블 렌더링
function renderAll(data) {
    if (!data) return;

    // 이전 타임아웃 취소 (경합 조건 방지)
    if (chartRenderTimeout) {
        clearTimeout(chartRenderTimeout);
        chartRenderTimeout = null;
    }

    // 먼저 모든 로딩 스피너 제거
    ['chartDesktopMobile', 'chartDesktop', 'chartMobile'].forEach(clearLoading);

    // 테이블 생성
    createTable('tableDesktopMobile', data.desktop_mobile, 'Desktop+Mobile');
    createTable('tableDesktop', data.desktop, 'Desktop');
    createTable('tableMobile', data.mobile, 'Mobile');

    // 차트 생성 (약간 지연 후 렌더링하여 DOM 업데이트 보장)
    chartRenderTimeout = setTimeout(() => {
        createStackedBarChart('chartDesktopMobile', data.desktop_mobile);
        createStackedBarChart('chartDesktop', data.desktop);
        createStackedBarChart('chartMobile', data.mobile);
        chartRenderTimeout = null;
    }, 50);
}

// 필터 적용
function applyFilter() {
    const fromDate = document.getElementById('filterFrom').value;
    const toDate = document.getElementById('filterTo').value;

    if (!globalData) return;

    // 입력값 검증
    if (!allDates.includes(fromDate) || !allDates.includes(toDate)) {
        alert('유효한 날짜를 입력해주세요. (예: 2019-01)');
        return;
    }

    const filteredData = {
        desktop_mobile: filterDataByDateRange(globalData.desktop_mobile, fromDate, toDate),
        desktop: filterDataByDateRange(globalData.desktop, fromDate, toDate),
        mobile: filterDataByDateRange(globalData.mobile, fromDate, toDate)
    };

    renderAll(filteredData);
}

// 필터 리셋
function resetFilter() {
    if (!globalData || !globalData.desktop_mobile.dates) return;

    const dates = globalData.desktop_mobile.dates;
    document.getElementById('filterFrom').value = dates[0];
    document.getElementById('filterTo').value = dates[dates.length - 1];

    document.querySelectorAll('.quick-filter').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.months === '0') btn.classList.add('active');
    });

    renderAll(globalData);
}

// Quick filter 적용
function applyQuickFilter(months) {
    if (!globalData || !globalData.desktop_mobile.dates) return;

    const dates = globalData.desktop_mobile.dates;
    const toDate = dates[dates.length - 1];

    let fromDate;
    if (months === 0) {
        fromDate = dates[0];
    } else {
        const fromIdx = Math.max(0, dates.length - months);
        fromDate = dates[fromIdx];
    }

    document.getElementById('filterFrom').value = fromDate;
    document.getElementById('filterTo').value = toDate;

    applyFilter();
}

// 이벤트 리스너 설정
document.getElementById('btnApplyFilter').addEventListener('click', applyFilter);
document.getElementById('btnResetFilter').addEventListener('click', resetFilter);

document.querySelectorAll('.quick-filter').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.quick-filter').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        applyQuickFilter(parseInt(this.dataset.months));
    });
});

// Enter 키로 필터 적용
document.getElementById('filterFrom').addEventListener('keypress', e => { if (e.key === 'Enter') applyFilter(); });
document.getElementById('filterTo').addEventListener('keypress', e => { if (e.key === 'Enter') applyFilter(); });

// 데이터 로드 및 렌더링 (30초 타임아웃 적용)
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 30000);

fetch('/api/search-engine/all', { signal: controller.signal })
    .then(res => {
        clearTimeout(timeoutId);
        if (!res.ok) throw new Error('API Error: ' + res.status);
        return res.json();
    })
    .then(data => {
        console.log('Data loaded:', data);
        globalData = data;

        if (data.desktop_mobile && data.desktop_mobile.dates && data.desktop_mobile.dates.length > 0) {
            populateDateFilters(data.desktop_mobile.dates);
            renderAll(data);
        } else {
            throw new Error('No data in response');
        }
    })
    .catch(err => {
        clearTimeout(timeoutId);
        console.error('Error:', err);
        let errorMsg;
        if (err.name === 'AbortError') {
            errorMsg = '<p class="text-danger text-center py-3">데이터 로드 시간 초과 (30초).<br><small>네트워크 상태를 확인하거나 나중에 다시 시도해주세요.</small></p>';
        } else {
            errorMsg = '<p class="text-danger text-center py-3">데이터 로드 실패. 캐시 파일이 없을 수 있습니다.<br><small>관리자에게 update_cache.py 실행을 요청하세요.</small></p>';
        }
        ['tableDesktopMobile', 'tableDesktop', 'tableMobile'].forEach(id => {
            document.getElementById(id).innerHTML = errorMsg;
        });
        ['chartDesktopMobile', 'chartDesktop', 'chartMobile'].forEach(id => {
            document.getElementById(id).innerHTML = errorMsg;
        });
    });
</script>
{% endblock %}
