{% extends "base.html" %}

{% block title %}Active ETF - 고객상품전략팀{% endblock %}

{% block extra_css %}
<style>
    .tab-button {
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
        cursor: pointer;
        background: none;
        border-top: none;
        border-left: none;
        border-right: none;
        color: #717182;
    }

    .tab-button:hover {
        color: #030213;
        background-color: #f3f3f5;
    }

    .tab-button.active {
        color: #030213;
        border-bottom-color: #030213;
        font-weight: 600;
    }

    .badge-custom {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .badge-green {
        background-color: #dcfce7;
        color: #166534;
    }

    .badge-red {
        background-color: #fee2e2;
        color: #991b1b;
    }

    .badge-blue {
        background-color: #dbeafe;
        color: #1e40af;
    }

    .badge-orange {
        background-color: #ffedd5;
        color: #9a3412;
    }

    .stock-table {
        width: 100%;
        border-collapse: collapse;
    }

    .stock-table th {
        text-align: left;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        font-weight: 600;
        color: #717182;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .stock-table td {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .stock-table tbody tr:hover {
        background-color: #f3f3f5;
    }

    .loading-spinner {
        display: inline-block;
        width: 1.5rem;
        height: 1.5rem;
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-top-color: #030213;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .change-icon {
        width: 1.25rem;
        height: 1.25rem;
        display: inline-block;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Active ETF Monitor</h1>
        <p class="text-gray-600">실시간 ETF 포트폴리오 리밸런싱 분석</p>
    </div>

    <!-- Date Picker -->
    <div class="card-custom p-4 mb-6">
        <div class="flex items-center gap-4">
            <label for="datePicker" class="text-sm font-medium text-gray-700">기준일</label>
            <input 
                type="date" 
                id="datePicker" 
                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                value=""
            >
            <button onclick="loadAllETFData()" class="btn-custom btn-custom-default btn-custom-md">
                <i class="bi bi-arrow-clockwise"></i>
                조회
            </button>
        </div>
    </div>

    <!-- ETF Tabs -->
    <div class="card-custom mb-6">
        <div class="border-b border-gray-200 flex space-x-1 px-4">
            <button class="tab-button active" data-etf-id="time_sp500">TIME S&P500</button>
            <button class="tab-button" data-etf-id="time_nasdaq100">TIME NASDAQ100</button>
            <button class="tab-button" data-etf-id="kiwoom_growth30">KOSEF 미국성장기업30</button>
        </div>

        <!-- Tab Content Container -->
        <div id="etfContent" class="p-6">
            <div class="flex justify-center items-center py-12">
                <div class="loading-spinner"></div>
                <span class="ml-3 text-gray-600">데이터를 불러오는 중...</span>
            </div>
        </div>
    </div>
</div>

<script>
    let currentETFId = 'time_sp500';
    let etfData = {};

    // 초기화
    document.addEventListener('DOMContentLoaded', function() {
        // 한국시간 기준 오늘 날짜 계산
        const now = new Date();
        const kstOffset = 9 * 60; // KST is UTC+9
        const kstTime = new Date(now.getTime() + (kstOffset - now.getTimezoneOffset()) * 60000);
        const today = kstTime.toISOString().split('T')[0];

        const datePicker = document.getElementById('datePicker');
        datePicker.value = today;

        // 최근 7일로 날짜 제한 (캐시된 데이터만 조회)
        const sevenDaysAgo = new Date(kstTime);
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        const minDate = sevenDaysAgo.toISOString().split('T')[0];

        datePicker.setAttribute('min', minDate);
        datePicker.setAttribute('max', today);

        // Tab 클릭 이벤트
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentETFId = this.getAttribute('data-etf-id');
                renderETFContent(currentETFId);
            });
        });

        // 초기 데이터 로드
        loadAllETFData();
    });

    // 모든 ETF 데이터 로드
    async function loadAllETFData() {
        const date = document.getElementById('datePicker').value;
        const etfIds = ['time_sp500', 'time_nasdaq100', 'kiwoom_growth30'];

        // 로딩 표시
        document.getElementById('etfContent').innerHTML = `
            <div class="flex justify-center items-center py-12">
                <div class="loading-spinner"></div>
                <span class="ml-3 text-gray-600">데이터를 불러오는 중...</span>
            </div>
        `;

        try {
            // 병렬로 모든 ETF 데이터 로드
            const promises = etfIds.map(id => 
                fetch(`/api/etf/data/${id}?date=${date}`)
                    .then(res => res.json())
            );

            const results = await Promise.all(promises);
            
            etfIds.forEach((id, idx) => {
                etfData[id] = results[idx];
            });

            // 현재 선택된 ETF 렌더링
            renderETFContent(currentETFId);

        } catch (error) {
            console.error('Error loading ETF data:', error);
            document.getElementById('etfContent').innerHTML = `
                <div class="text-center py-12">
                    <p class="text-red-600">데이터 로드 중 오류가 발생했습니다.</p>
                    <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                </div>
            `;
        }
    }

    // ETF 콘텐츠 렌더링
    function renderETFContent(etfId) {
        const data = etfData[etfId];
        
        if (!data || data.error) {
            document.getElementById('etfContent').innerHTML = `
                <div class="text-center py-12">
                    <p class="text-gray-600">데이터가 없습니다.</p>
                    <p class="text-sm text-gray-500 mt-2">${data?.error || '다른 날짜를 선택해주세요.'}</p>
                </div>
            `;
            return;
        }

        const summary = data.summary || {};
        const rebalancing = data.rebalancing || {};

        const html = `
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="card-custom p-4">
                    <div class="text-sm text-gray-600 mb-1">총 보유종목</div>
                    <div class="text-2xl font-bold text-gray-900">${summary.total_positions || 0}</div>
                </div>
                <div class="card-custom p-4">
                    <div class="text-sm text-gray-600 mb-1">신규 편입</div>
                    <div class="text-2xl font-bold text-green-600">${summary.new_count || 0}</div>
                </div>
                <div class="card-custom p-4">
                    <div class="text-sm text-gray-600 mb-1">편출</div>
                    <div class="text-2xl font-bold text-red-600">${summary.removed_count || 0}</div>
                </div>
                <div class="card-custom p-4">
                    <div class="text-sm text-gray-600 mb-1">비중변화</div>
                    <div class="text-2xl font-bold text-blue-600">${(summary.increased_count || 0) + (summary.decreased_count || 0)}</div>
                </div>
            </div>

            <!-- Daily Rebalancing Summary -->
            <div class="card-custom p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Daily Rebalancing Summary</h3>
                <div class="text-sm text-gray-600 mb-4">
                    Base Date: ${data.base_date || 'N/A'} | Previous Date: ${data.prev_date || 'N/A'}
                </div>

                <div class="space-y-4">
                    ${renderRebalancingSection('신규 편입', rebalancing.new_stocks, 'green', 'plus-circle')}
                    ${renderRebalancingSection('편출', rebalancing.removed_stocks, 'red', 'dash-circle')}
                    ${renderRebalancingSection('비중 확대', rebalancing.increased_stocks, 'blue', 'arrow-up-circle')}
                    ${renderRebalancingSection('비중 축소', rebalancing.decreased_stocks, 'orange', 'arrow-down-circle')}
                </div>
            </div>

            <!-- AI Analysis (Empty) -->
            <div class="card-custom p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="bi bi-stars mr-2"></i>AI Analysis
                </h3>
                <div class="text-center py-8 text-gray-400">
                    <i class="bi bi-hourglass-split text-3xl mb-2"></i>
                    <p>AI 분석 기능은 곧 제공될 예정입니다.</p>
                </div>
            </div>

            <!-- Top 10 Holdings -->
            <div class="card-custom p-6">
                <h3 class="text-lg font-semibold mb-4">Top 10 Holdings</h3>
                <div class="overflow-x-auto">
                    <table class="stock-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Ticker</th>
                                <th>Name</th>
                                <th class="text-right">Weight (%)</th>
                                <th class="text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${renderTopHoldings(data.top_holdings || [])}
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        document.getElementById('etfContent').innerHTML = html;
    }

    // 리밸런싱 섹션 렌더링
    function renderRebalancingSection(title, stocks, color, icon) {
        if (!stocks || stocks.length === 0) {
            return `
                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <span class="badge-custom badge-${color}">
                            <i class="bi bi-${icon}"></i>
                            ${title}
                        </span>
                        <span class="text-sm text-gray-500">0건</span>
                    </div>
                    <p class="text-sm text-gray-400 ml-8">변동 없음</p>
                </div>
            `;
        }

        const stockList = stocks.slice(0, 5).map(s => 
            `<span class="text-sm text-gray-700">${s.종목명} (${s.종목코드})</span>`
        ).join(', ');

        const moreText = stocks.length > 5 ? ` 외 ${stocks.length - 5}건` : '';

        return `
            <div>
                <div class="flex items-center gap-2 mb-2">
                    <span class="badge-custom badge-${color}">
                        <i class="bi bi-${icon}"></i>
                        ${title}
                    </span>
                    <span class="text-sm text-gray-500">${stocks.length}건</span>
                </div>
                <p class="text-sm ml-8">${stockList}${moreText}</p>
            </div>
        `;
    }

    // Top Holdings 렌더링
    function renderTopHoldings(holdings) {
        if (!holdings || holdings.length === 0) {
            return '<tr><td colspan="5" class="text-center text-gray-400 py-8">데이터가 없습니다.</td></tr>';
        }

        return holdings.map((stock, idx) => `
            <tr>
                <td class="font-semibold">${idx + 1}</td>
                <td class="font-mono text-sm">${stock.종목코드}</td>
                <td>${stock.종목명}</td>
                <td class="text-right font-semibold">${stock.비중.toFixed(2)}%</td>
                <td class="text-right">${formatNumber(stock.평가금액)}</td>
            </tr>
        `).join('');
    }

    // 숫자 포맷팅
    function formatNumber(num) {
        if (!num) return '-';
        return new Intl.NumberFormat('ko-KR').format(Math.round(num));
    }
</script>
{% endblock %}
