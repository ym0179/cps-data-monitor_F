{% extends "base.html" %}

{% block title %}OS Market Share - Market Data{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-3">
    <!-- 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="mb-1"><i class="bi bi-phone text-primary me-2"></i>OS Market Share</h4>
            <p class="text-muted mb-0">
                <small>Data Source: <a href="https://gs.statcounter.com/os-market-share" target="_blank">StatCounter Global Stats</a> (2009 ~ Present)</small>
            </p>
        </div>
    </div>

    <!-- 필터 및 다운로드 섹션 -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row align-items-end">
                <!-- 디바이스 선택 -->
                <div class="col-md-3 mb-2">
                    <label class="form-label fw-bold">Device</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="osDevice" id="osMobile" value="mobile" checked>
                        <label class="btn btn-outline-primary" for="osMobile">Mobile</label>
                        <input type="radio" class="btn-check" name="osDevice" id="osTablet" value="tablet">
                        <label class="btn btn-outline-primary" for="osTablet">Tablet</label>
                    </div>
                </div>

                <!-- 날짜 필터 -->
                <div class="col-md-3 mb-2">
                    <label for="osStartDate" class="form-label fw-bold">Start Date</label>
                    <input type="month" class="form-control" id="osStartDate" value="2020-01">
                </div>
                <div class="col-md-3 mb-2">
                    <label for="osEndDate" class="form-label fw-bold">End Date</label>
                    <input type="month" class="form-control" id="osEndDate">
                </div>

                <!-- 버튼 -->
                <div class="col-md-3 mb-2">
                    <button class="btn btn-primary w-100 mb-1" onclick="applyOSFilter()">
                        <i class="bi bi-funnel me-1"></i>Apply Filter
                    </button>
                    <button class="btn btn-success w-100" onclick="downloadOSExcel()">
                        <i class="bi bi-download me-1"></i>Download Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 차트 섹션 -->
    <div class="card mb-4">
        <div class="card-header">
            <span class="fw-bold"><i class="bi bi-graph-up me-2"></i>OS Market Share Chart</span>
        </div>
        <div class="card-body">
            <div id="osChart" style="height: 450px;">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Loading data...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 데이터 테이블 섹션 -->
    <div class="card">
        <div class="card-header">
            <span class="fw-bold"><i class="bi bi-table me-2"></i>Data Table</span>
        </div>
        <div class="card-body">
            <div id="osTable">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Loading data...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Plotly.js -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<script>
let currentOSData = null;
let currentDevice = 'mobile';

// 현재 날짜를 YYYY-MM 형식으로 설정
document.getElementById('osEndDate').value = new Date().toISOString().slice(0, 7);

// OS 데이터 로드
function loadOSData(device) {
    currentDevice = device;

    // 로딩 표시
    document.getElementById('osChart').innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">Loading data...</p></div>';
    document.getElementById('osTable').innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">Loading data...</p></div>';

    fetch(`/api/os-rivalry?device=${device}`)
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                document.getElementById('osChart').innerHTML = '<p class="text-danger text-center py-5">Failed to load data</p>';
                document.getElementById('osTable').innerHTML = '<p class="text-danger text-center py-5">Failed to load data</p>';
                return;
            }

            currentOSData = data;
            renderOSChart(data);
            renderOSTable(data);
        })
        .catch(err => {
            console.error('Error loading OS data:', err);
            document.getElementById('osChart').innerHTML = '<p class="text-danger text-center py-5">Error loading data</p>';
            document.getElementById('osTable').innerHTML = '<p class="text-danger text-center py-5">Error loading data</p>';
        });
}

// 차트 렌더링
function renderOSChart(data) {
    const container = document.getElementById('osChart');

    try {
        const traces = [];
        const colors = { 'Android': '#3DDC84', 'iOS': '#555555' };

        for (const [name, values] of Object.entries(data.series)) {
            traces.push({
                x: data.dates,
                y: values,
                name: name,
                type: 'scatter',
                mode: 'lines',
                line: { width: 3, color: colors[name] || '#999999' },
                connectgaps: false,
                hovertemplate: '%{fullData.name}<br>%{x}<br>%{y:.2f}%<extra></extra>'
            });
        }

        const layout = {
            title: `OS Market Share (${currentDevice})`,
            xaxis: { title: 'Date' },
            yaxis: { title: 'Market Share (%)', range: [0, 100] },
            hovermode: 'x unified',
            legend: { orientation: 'h', y: -0.2 }
        };

        const config = {
            responsive: true,
            displayModeBar: false
        };

        Plotly.newPlot('osChart', traces, layout, config)
            .catch(err => {
                console.error('Plotly render error:', err);
                container.innerHTML = '<p class="text-danger text-center py-5">차트 렌더링 실패</p>';
            });
    } catch (err) {
        console.error('Chart creation error:', err);
        container.innerHTML = '<p class="text-danger text-center py-5">차트 생성 오류</p>';
    }
}

// 테이블 렌더링
function renderOSTable(data) {
    const container = document.getElementById('osTable');

    try {
        if (!data.dates || data.dates.length === 0) {
            container.innerHTML = '<p class="text-center text-muted py-3">No data available</p>';
            return;
        }

        // 테이블 생성
        let tableHTML = `
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>Date</th>
        `;

        // 헤더 추가
        for (const name of Object.keys(data.series)) {
            tableHTML += `<th class="text-end">${name}</th>`;
        }
        tableHTML += '</tr></thead><tbody>';

        // 데이터 행 추가 (최신 데이터가 위로 오도록 역순)
        for (let i = data.dates.length - 1; i >= 0; i--) {
            tableHTML += `<tr><td>${data.dates[i]}</td>`;
            for (const values of Object.values(data.series)) {
                const value = values[i];
                if (value !== null && value !== undefined && !isNaN(value)) {
                    tableHTML += `<td class="text-end">${value.toFixed(2)}%</td>`;
                } else {
                    tableHTML += `<td class="text-end text-muted">-</td>`;
                }
            }
            tableHTML += '</tr>';
        }

        tableHTML += '</tbody></table></div>';
        container.innerHTML = tableHTML;
    } catch (err) {
        console.error('Table creation error:', err);
        container.innerHTML = '<p class="text-danger text-center py-5">테이블 생성 오류</p>';
    }
}

// 날짜 필터 적용
function applyOSFilter() {
    if (!currentOSData) return;

    const startDate = document.getElementById('osStartDate').value;
    const endDate = document.getElementById('osEndDate').value;

    if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
    }

    if (startDate > endDate) {
        alert('Start date must be before end date');
        return;
    }

    // 필터링된 데이터 생성
    const filteredData = {
        dates: [],
        series: {}
    };

    // series 초기화
    for (const name of Object.keys(currentOSData.series)) {
        filteredData.series[name] = [];
    }

    // 날짜 필터링
    for (let i = 0; i < currentOSData.dates.length; i++) {
        const date = currentOSData.dates[i];
        const yearMonth = date.substring(0, 7); // YYYY-MM 형식

        if (yearMonth >= startDate && yearMonth <= endDate) {
            filteredData.dates.push(date);
            for (const [name, values] of Object.entries(currentOSData.series)) {
                filteredData.series[name].push(values[i]);
            }
        }
    }

    if (filteredData.dates.length === 0) {
        alert('No data available for the selected date range');
        return;
    }

    renderOSChart(filteredData);
    renderOSTable(filteredData);
}

// Excel 다운로드
function downloadOSExcel() {
    if (!currentOSData) {
        alert('No data to download');
        return;
    }

    const startDate = document.getElementById('osStartDate').value;
    const endDate = document.getElementById('osEndDate').value;

    window.location.href = `/api/os-rivalry/download?device=${currentDevice}&start_date=${startDate}&end_date=${endDate}`;
}

// 디바이스 변경 이벤트
document.querySelectorAll('input[name="osDevice"]').forEach(radio => {
    radio.addEventListener('change', (e) => loadOSData(e.target.value));
});

// 초기 로드
loadOSData('mobile');
</script>
{% endblock %}
