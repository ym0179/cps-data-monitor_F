{% extends "base.html" %}

{% block title %}OS Market Share - Market Data{% endblock %}

{% block extra_css %}
<style>
    /* 데이터 테이블 스타일 */
    .data-table {
        font-size: 11px;
        overflow-x: auto;
    }
    .data-table table {
        min-width: 100%;
        border-collapse: collapse;
        width: 100%;
    }
    .data-table th, .data-table td {
        padding: 6px 8px;
        text-align: center;
        border: 1px solid #e5e7eb;
        white-space: nowrap;
    }
    .data-table th {
        background: #f9fafb;
        font-weight: 600;
        position: sticky;
        left: 0;
        z-index: 1;
    }
    .data-table td:first-child {
        position: sticky;
        left: 0;
        background: #fff;
        font-weight: 500;
        z-index: 1;
    }
    /* 색상 포맷팅 */
    .bg-android { background-color: #c6efce !important; color: #006100; }
    .bg-ios { background-color: #f2f2f2 !important; }

    .chart-container {
        height: 320px;
    }

    /* Tab 스타일 */
    .tab-btn {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        border-bottom: 2px solid transparent;
        color: #6b7280;
        transition: all 0.2s;
    }
    .tab-btn:hover {
        color: #111827;
    }
    .tab-btn.active {
        color: #111827;
        border-bottom-color: #111827;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- 헤더 -->
    <div>
        <div class="flex items-center space-x-2">
            <h1 class="text-3xl font-semibold text-gray-900">OS Market Share</h1>
            <i class="bi bi-info-circle text-gray-400 w-4 h-4"></i>
        </div>
        <p class="text-gray-600 mt-1 text-sm">
            Android vs iOS market share comparison • Data Source: <a href="https://gs.statcounter.com/os-market-share" target="_blank" class="text-blue-600 hover:underline">StatCounter Global Stats</a> (Jan 2019 ~ Present)
        </p>
    </div>

    <!-- 필터 섹션 -->
    <div class="card-custom">
        <div class="p-4">
            <div class="flex flex-wrap items-center gap-3">
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">
                        <i class="bi bi-calendar-range mr-1"></i>기간 선택:
                    </label>
                    <input type="text" id="filterFrom" class="px-3 py-1.5 border border-gray-300 rounded-md text-sm w-24 text-center" list="dateListFrom" placeholder="YYYY-MM">
                    <datalist id="dateListFrom"></datalist>
                    <span class="text-gray-500">~</span>
                    <input type="text" id="filterTo" class="px-3 py-1.5 border border-gray-300 rounded-md text-sm w-24 text-center" list="dateListTo" placeholder="YYYY-MM">
                    <datalist id="dateListTo"></datalist>
                </div>
                <button id="btnApplyFilter" class="btn-custom btn-custom-default btn-custom-sm">
                    <i class="bi bi-funnel"></i> 적용
                </button>
                <button id="btnResetFilter" class="btn-custom btn-custom-outline btn-custom-sm">
                    <i class="bi bi-arrow-counterclockwise"></i> 전체보기
                </button>
                <div class="flex items-center bg-gray-100 rounded-md p-1 ml-2">
                    <button type="button" class="quick-filter px-3 py-1 text-xs font-medium rounded transition-colors hover:bg-white hover:shadow-sm" data-months="12">1Y</button>
                    <button type="button" class="quick-filter px-3 py-1 text-xs font-medium rounded transition-colors hover:bg-white hover:shadow-sm" data-months="36">3Y</button>
                    <button type="button" class="quick-filter px-3 py-1 text-xs font-medium rounded transition-colors hover:bg-white hover:shadow-sm" data-months="60">5Y</button>
                    <button type="button" class="quick-filter active px-3 py-1 text-xs font-medium rounded bg-white shadow-sm" data-months="0">All</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 차트 섹션 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card-custom">
            <div class="px-6 pt-6">
                <h4 class="font-medium text-gray-900">Mobile</h4>
                <p class="text-xs text-gray-500 mt-0.5">Mobile OS market share (%)</p>
            </div>
            <div class="px-6 pb-6">
                <div id="chartMobile" class="chart-container">
                    <div class="flex items-center justify-center h-full">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-custom">
            <div class="px-6 pt-6">
                <h4 class="font-medium text-gray-900">Tablet</h4>
                <p class="text-xs text-gray-500 mt-0.5">Tablet OS market share (%)</p>
            </div>
            <div class="px-6 pb-6">
                <div id="chartTablet" class="chart-container">
                    <div class="flex items-center justify-center h-full">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-custom">
            <div class="px-6 pt-6">
                <h4 class="font-medium text-gray-900">Mobile+Tablet</h4>
                <p class="text-xs text-gray-500 mt-0.5">Combined market share (%)</p>
            </div>
            <div class="px-6 pb-6">
                <div id="chartCombined" class="chart-container">
                    <div class="flex items-center justify-center h-full">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 데이터 테이블 섹션 -->
    <div class="card-custom">
        <div class="flex items-center justify-between px-6 pt-6">
            <div>
                <h4 class="font-medium text-gray-900">Data Table</h4>
                <p class="text-xs text-gray-500 mt-0.5">Detailed market share data</p>
            </div>
            <button id="btnDownloadExcel" class="btn-custom btn-custom-outline btn-custom-sm">
                <i class="bi bi-download"></i> Export
            </button>
        </div>
        <div class="px-6 pb-6">
            <!-- Tabs -->
            <div class="flex border-b mt-4">
                <button class="tab-btn active" data-tab="mobile">
                    <i class="bi bi-phone mr-1"></i>Mobile
                </button>
                <button class="tab-btn" data-tab="tablet">
                    <i class="bi bi-tablet mr-1"></i>Tablet
                </button>
                <button class="tab-btn" data-tab="combined">
                    <i class="bi bi-phone-landscape mr-1"></i>Mobile+Tablet
                </button>
            </div>

            <!-- Tab Contents -->
            <div class="mt-4">
                <div class="tab-content active" data-content="mobile">
                    <div class="data-table" id="tableMobile">
                        <div class="flex items-center justify-center py-8">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-gray-900"></div>
                        </div>
                    </div>
                </div>
                <div class="tab-content" data-content="tablet">
                    <div class="data-table" id="tableTablet">
                        <div class="flex items-center justify-center py-8">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-gray-900"></div>
                        </div>
                    </div>
                </div>
                <div class="tab-content" data-content="combined">
                    <div class="data-table" id="tableCombined">
                        <div class="flex items-center justify-center py-8">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-gray-900"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="px-6 pb-6 text-xs text-gray-500 border-t pt-4 mt-2">
            <p>Last updated: <span id="lastUpdated"></span></p>
        </div>
    </div>
</div>

<!-- Plotly.js -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<script>
let rawDataMobile = null;
let rawDataTablet = null;
let rawDataCombined = null;
let currentFilterFrom = null;
let currentFilterTo = null;
let allDates = [];

// 행 색상 클래스 매핑
function getRowClass(name) {
    if (name.includes('Android')) return 'bg-android';
    if (name.includes('iOS')) return 'bg-ios';
    return '';
}

// Tab 전환 기능
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const tab = this.dataset.tab;
        
        // 탭 버튼 활성화
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // 탭 콘텐츠 표시
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`[data-content="${tab}"]`).classList.add('active');
    });
});

// 데이터 로드
function loadAllData() {
    Promise.all([
        fetch('/api/os-rivalry?device=mobile').then(res => res.json()),
        fetch('/api/os-rivalry?device=tablet').then(res => res.json()),
        fetch('/api/os-rivalry-combined').then(res => res.json())
    ]).then(([mobile, tablet, combined]) => {
        rawDataMobile = mobile;
        rawDataTablet = tablet;
        rawDataCombined = combined;

        // 날짜 목록 생성 (mobile 기준)
        if (mobile.dates && mobile.dates.length > 0) {
            allDates = mobile.dates;
            const dateListFrom = document.getElementById('dateListFrom');
            const dateListTo = document.getElementById('dateListTo');

            mobile.dates.forEach(date => {
                const optFrom = document.createElement('option');
                optFrom.value = date;
                dateListFrom.appendChild(optFrom);

                const optTo = document.createElement('option');
                optTo.value = date;
                dateListTo.appendChild(optTo);
            });

            // 기본값 설정
            document.getElementById('filterFrom').value = mobile.dates[0];
            document.getElementById('filterTo').value = mobile.dates[mobile.dates.length - 1];
        }

        renderAllCharts();
        renderAllTables();

        // Last updated 설정
        const now = new Date();
        document.getElementById('lastUpdated').textContent = now.toLocaleString('ko-KR');
    }).catch(err => {
        console.error('Data load error:', err);
        const errorMsg = '<p class="text-center text-red-600 py-4">데이터 로드 실패</p>';
        ['tableMobile', 'tableTablet', 'tableCombined'].forEach(id => {
            document.getElementById(id).innerHTML = errorMsg;
        });
        ['chartMobile', 'chartTablet', 'chartCombined'].forEach(id => {
            document.getElementById(id).innerHTML = errorMsg;
        });
    });
}

// 데이터 필터링
function filterDataByDateRange(data) {
    if (!data || !data.dates || !currentFilterFrom || !currentFilterTo) return data;

    const filteredData = {
        dates: [],
        series: {}
    };

    // series 초기화
    Object.keys(data.series).forEach(key => {
        filteredData.series[key] = [];
    });

    // 날짜 필터링
    data.dates.forEach((date, idx) => {
        if (date >= currentFilterFrom && date <= currentFilterTo) {
            filteredData.dates.push(date);
            Object.keys(data.series).forEach(key => {
                filteredData.series[key].push(data.series[key][idx]);
            });
        }
    });

    return filteredData;
}

// 테이블 생성 (가로 날짜, 세로 OS)
function createTable(containerId, data, deviceName) {
    const container = document.getElementById(containerId);

    try {
        // 필터링된 데이터 사용
        const displayData = currentFilterFrom && currentFilterTo ? filterDataByDateRange(data) : data;

        if (!displayData || !displayData.dates || displayData.dates.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 py-4">데이터 없음</p>';
            return;
        }

        const dates = displayData.dates;
        const osNames = Object.keys(displayData.series);

        let html = '<div style="overflow-x:auto;"><table><thead><tr><th></th>';

        // 날짜 헤더 (가로)
        dates.forEach(d => {
            html += `<th>${d}</th>`;
        });
        html += '</tr></thead><tbody>';

        // OS별 행 (세로)
        osNames.forEach(osName => {
            const rowClass = getRowClass(osName);
            html += `<tr class="${rowClass}"><td>${osName} (${deviceName})</td>`;

            displayData.series[osName].forEach(v => {
                const displayVal = (v !== null && v !== undefined && !isNaN(v)) ? v.toFixed(2) : '-';
                html += `<td>${displayVal}</td>`;
            });
            html += '</tr>';
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    } catch (err) {
        console.error('Table creation error:', err);
        container.innerHTML = '<p class="text-center text-red-600 py-4">테이블 생성 오류</p>';
    }
}

// 차트 생성
function createChart(containerId, data, device) {
    const container = document.getElementById(containerId);

    try {
        container.innerHTML = '';

        // 필터링된 데이터 사용
        const displayData = currentFilterFrom && currentFilterTo ? filterDataByDateRange(data) : data;

        if (!displayData || !displayData.dates || displayData.dates.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 flex items-center justify-center h-full">데이터 없음</p>';
            return;
        }

        const traces = [];
        const colors = { 'Android': '#3DDC84', 'iOS': '#555555' };

        Object.keys(displayData.series).forEach(name => {
            traces.push({
                x: displayData.dates,
                y: displayData.series[name],
                name: name,
                type: 'scatter',
                mode: 'lines',
                line: { width: 2, color: colors[name] || '#999999' },
                connectgaps: false,
                hovertemplate: '%{fullData.name}<br>%{x}<br>%{y:.2f}%<extra></extra>'
            });
        });

        const layout = {
            margin: { l: 40, r: 20, t: 10, b: 40 },
            xaxis: { title: '' },
            yaxis: { title: 'Market Share (%)', range: [0, 100] },
            hovermode: 'x unified',
            legend: {
                orientation: 'h',
                y: -0.2,
                x: 0.5,
                xanchor: 'center',
                font: { size: 10 }
            },
            showlegend: true,
            paper_bgcolor: 'white',
            plot_bgcolor: 'white'
        };

        const config = {
            responsive: true,
            displayModeBar: false
        };

        Plotly.newPlot(containerId, traces, layout, config);
    } catch (err) {
        console.error('Chart creation error:', err);
        container.innerHTML = '<p class="text-center text-red-600 flex items-center justify-center h-full">차트 생성 오류</p>';
    }
}

// 모든 차트 렌더링
function renderAllCharts() {
    setTimeout(() => {
        createChart('chartMobile', rawDataMobile, 'mobile');
        createChart('chartTablet', rawDataTablet, 'tablet');
        createChart('chartCombined', rawDataCombined, 'mobile+tablet');
    }, 50);
}

// 모든 테이블 렌더링
function renderAllTables() {
    createTable('tableMobile', rawDataMobile, 'Mobile');
    createTable('tableTablet', rawDataTablet, 'Tablet');
    createTable('tableCombined', rawDataCombined, 'Mobile+Tablet');
}

// 필터 적용
document.getElementById('btnApplyFilter').addEventListener('click', () => {
    currentFilterFrom = document.getElementById('filterFrom').value;
    currentFilterTo = document.getElementById('filterTo').value;

    if (!currentFilterFrom || !currentFilterTo) {
        alert('시작 날짜와 종료 날짜를 모두 입력하세요');
        return;
    }

    if (currentFilterFrom > currentFilterTo) {
        alert('시작 날짜가 종료 날짜보다 뒤일 수 없습니다');
        return;
    }

    document.querySelectorAll('.quick-filter').forEach(btn => {
        btn.classList.remove('active', 'bg-white', 'shadow-sm');
    });
    renderAllCharts();
    renderAllTables();
});

// 필터 초기화
document.getElementById('btnResetFilter').addEventListener('click', () => {
    if (allDates.length > 0) {
        document.getElementById('filterFrom').value = allDates[0];
        document.getElementById('filterTo').value = allDates[allDates.length - 1];
        currentFilterFrom = null;
        currentFilterTo = null;
        document.querySelectorAll('.quick-filter').forEach(btn => {
            btn.classList.remove('active', 'bg-white', 'shadow-sm');
        });
        document.querySelector('.quick-filter[data-months="0"]').classList.add('active', 'bg-white', 'shadow-sm');
        renderAllCharts();
        renderAllTables();
    }
});

// 빠른 필터
document.querySelectorAll('.quick-filter').forEach(btn => {
    btn.addEventListener('click', function() {
        const months = parseInt(this.getAttribute('data-months'));

        document.querySelectorAll('.quick-filter').forEach(b => {
            b.classList.remove('active', 'bg-white', 'shadow-sm');
        });
        this.classList.add('active', 'bg-white', 'shadow-sm');

        if (months === 0) {
            // 전체보기
            document.getElementById('btnResetFilter').click();
        } else if (allDates.length > 0) {
            const endDate = allDates[allDates.length - 1];
            const endDateObj = new Date(endDate + '-01');
            endDateObj.setMonth(endDateObj.getMonth() - months);
            const startDate = endDateObj.toISOString().slice(0, 7);

            document.getElementById('filterFrom').value = startDate;
            document.getElementById('filterTo').value = endDate;
            currentFilterFrom = startDate;
            currentFilterTo = endDate;

            renderAllCharts();
            renderAllTables();
        }
    });
});

// Excel 다운로드 (3개 시트 모두 포함)
document.getElementById('btnDownloadExcel').addEventListener('click', (e) => {
    e.preventDefault();

    const from = document.getElementById('filterFrom').value || '2019-01';
    const to = document.getElementById('filterTo').value || new Date().toISOString().slice(0, 7);

    window.location.href = `/api/os-rivalry/download?start_date=${from}&end_date=${to}`;
});

// 초기 로드
loadAllData();
</script>
{% endblock %}
